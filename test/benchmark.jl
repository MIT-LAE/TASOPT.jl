
using Pkg, Dates
println(today())
println("Current location $(pwd())")
Pkg.activate("../")
Pkg.instantiate()

using BenchmarkTools, BenchmarkPlots, StatsPlots

println("Loading TASOPT...")
include("../tasopt.jl")
Pkg.precompile()

println("Loading input file...")
include("input.jl")

println("Start Benchmarking...")

function benchmark_fuseBL()
println("---------------------------------------")
println("Fuselage boundary layer calculations")
println("---------------------------------------")

# Blax benchmarks
# Load required inputs:
ndim, n, ite = 60, 47, 31
xi  = vec([0.0000000000000000       0.44074620753680366        1.2190552270904040        2.3347760331235596        3.7887094567541970
    5.5718945978404708        7.6689972125944621        10.060434488482580        12.733770402821520        15.671866977274471
    18.842564947775848        22.211125483849631        25.740641931345998        29.392444169467371        33.126522288704130  
    36.901964947775845        40.677407606847567        44.411485726084329        48.063287964205706        51.592812898021521
    54.963348718681608        58.142735530561986        61.098971670733697        63.800414794198794        66.216309192726627
    68.317498170117346        70.077257917641631        71.472178009771781        72.483011008870633        73.095418495955613
    73.297402905362347        73.495381125374095        74.086800998417502        75.065298459040292        76.420152884300123
    78.136520205592305        80.195595543371837        82.574819237348777        85.248124014847377        88.186220589300319
    91.356918559801699        94.725479095875485        98.254995543371834        101.90679778149321        105.64087590072997
    109.41631855980170        113.19176121887341        0.0000000000000000        0.0000000000000000        0.0000000000000000  
    0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000
    0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000  ]') 
    
bi  = vec([0.0000000000000000        2.4745511871254950        5.6535415917897565        9.0217956483937876        12.336388130013924        15.374699459348015        17.872596591715805        19.389265103084938        19.470334629888100        19.470334629888100
    19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.470334629888100        19.421703717200348   
    18.696774608355046        17.220896249239004        15.166375014370439        12.722898324790991        10.088149927191735        7.4581743328295298        5.0179224470423360        2.9324013010399628        1.3388230888588288       0.34010363924408998  
    8.5025909811022496E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002 
    4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   4.2512954905511248E-002   0.0000000000000000        0.0000000000000000        0.0000000000000000  
    0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000]')
    
rni = vec([0.31533826832660750       0.57173742702119768       0.81219724788257108       0.90269258705773681       0.94672640854476298       0.97226522293211493       0.98894104468671684       0.99845196426994509       0.99999680694540605        1.0000000000000000
        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000       0.99999937826068330       0.99982731522838886 
        0.99850586013772702       0.99567279498721784       0.99176744698370789       0.98718031684371466       0.98230291252748847       0.97750404726223072       0.97311231754692340       0.96940456031110123       0.96659922066293325       0.97648458361438661  
        0.99311284771759945       0.99967206764347949        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000   
        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000   
        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000]')  
        
uinv =vec([0.0000000000000000       0.41232788144791949       0.69484769448346606       0.87101389669788887       0.98128982294812661        1.0572777365191697        1.1155410538547457        1.1478334518053532        1.0397120834699256        1.0208483066788829 
    1.0127227677468640        1.0089122361149454        1.0069272130443903        1.0059647578243049        1.0057023491673989        1.0060860938835354        1.0073117470299502        1.0101187892512191        1.0166872541232435        1.0522914806404915   
    1.0579707508297382        1.0458008481139760        1.0251962472333744       0.99887261065736377       0.96838145651404639       0.93415127095380235       0.89482945664006042       0.84503460603174330       0.76665868462116227       0.57832861017479698
    0.67956954870494446       0.91085945297732340       0.94987185259890972       0.96867306763204752       0.97940819877458840       0.98600310693451965       0.99023015937220771       0.99302181211083229       0.99491017491688016       0.99621419067431638  
    0.99713156304792716       0.99778802355998475       0.99826525037457403       0.99861730269630800       0.99888057062100188       0.99907993608762147       0.99923266171096192        0.0000000000000000        0.0000000000000000        0.0000000000000000 
    0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000]')


Reyn = 7362062.6848912220 
Mach = 0.84 
fexcr = 1.03  

println("Benchmarking... blax")

b = @benchmarkable aerodynamics.blax($ndim, $n, $ite, $xi, $bi, $rni, $uinv,
 $Reyn, $Mach, $fexcr) seconds=30 evals=5
bench_blax = run(b)

println("Benchmarking... blax2")
b = @benchmarkable aerodynamics.blax2($ndim, $n, $ite, $xi, $bi, $rni, $uinv,
 $Reyn, $Mach, $fexcr) seconds=30 evals=5
bench_blax2 = run(b)

println("Benchmarking... fusebl")
b = @benchmarkable fusebl!($pari, $parg, $para, $ipcruise1) seconds=30 evals=5
bench_fusebl = run(b)

println("Benchmark results...")
println("\nNotes (from BenchmarkTools Manual):
- The minimum is a robust estimator for the location parameter of the time distribution, and should not be considered an outlier
- The median, as a robust measure of central tendency, should be relatively unaffected by outliers
- The mean, as a non-robust measure of central tendency, will usually be positively skewed by outliers
- The maximum should be considered a primarily noise-driven outlier, and can change drastically between benchmark trials.")
println("---------------------------------------")
println("blax (FORTRAN on MacPro M2 ~ 1.9 ms)")
println("---------------------------------------")
display(bench_blax)

println("---------------------------------------")
println("blax2 (FORTRAN on MacPro M2 ~ 1.9 ms)")
println("---------------------------------------")
display(bench_blax2)

println("---------------------------------------")
println("fusebl (FORTRAN on MacPro M2 ~ 1.95 ms)")
println("---------------------------------------")
display(bench_fusebl)
end

function benchmark_drag()
# ====================
#  Drag calculations
# ====================

println("\n---------------------------------------")
println("\nDrag calculations")
println("---------------------------------------")

Re = 2e6
println("Benchmarking... cfturb")
bench_cfturb = @benchmark aerodynamics.cfturb($Re)


# # aerodynamics.cditrp(pari, parg, view(para, :, ipcruise1))
# bench_cditrp = @benchmark aerodynamics.cditrp($pari, $parg,
#  $view(para, :, ipcruise1))
# println("---------------------------------------")
# println("cditrp (FORTRAN on MacPro M2 ~ 4.5 μs)")
# println("---------------------------------------")
# display(bench_cditrp)

nsurf = 2
npout = [20, 10]
npinn = [6, 0]
npimg = [3, 2]
Sref = 124.68530761144433
bref =  35.486921631434697
b = [35.486921631434697, 15.958117796995291]
bs = [10.113772664958887, 1.5240000000000000]
bo = [3.6067999999999998, 1.5240000000000000]
bop = [0.72136000000000000, 1.5240000000000000]
zcent = [-1.6764000000000001,  0.0000000000000000]
po = [1.0000000000000000, 1.0000000000000000]
gammat = [0.14999999999999999,  0.25000000000000000]
gammas = [0.77000000000000002,  1.0000000000000000]
fLo = -0.29999999999999999 
ktip = 16
Lspec = true
CLsurfsp =[1.2502595056643222, 1.1976021933848557E-002] 

println("Benchmarking... trefftz1")
b = @benchmarkable aerodynamics.trefftz1($nsurf, $npout,
                        $npinn, $npimg, 
	                    $Sref, $bref,
	                    $b,$bs,$bo,$bop, $zcent,
	                    $po,$gammat,$gammas, $fLo, $ktip,
                       $Lspec,$CLsurfsp) seconds=30 evals=50
bench_trefftz = run(b)

println("Benchmarking... cdsum!")
b = @benchmarkable aerodynamics.cdsum!($pari, $parg, 
$view(para, :, 10),
$view(pare,:, 10), $(1)) seconds=30 evals=1
bench_cdsum = run(b)



println("---------------------------------------")
println("cfturb (FORTRAN on MacPro M2 ~ --- μs)")
println("---------------------------------------")
display(bench_cfturb)

println("---------------------------------------")
println("trefftz (FORTRAN on MacPro M2 ~ 4.6 μs)")
println("---------------------------------------")
display(bench_trefftz)

println("---------------------------------------")
println("cdsum (FORTRAN on MacPro M2 ~ 5.8 - 6.0 μs)")
println("---------------------------------------")
display(bench_cdsum)

end

include("../Models/ZISA/ZIA_SAF_BLI_10_8_0.647_17.4.mdl")
benchmark_fuseBL()
benchmark_drag()