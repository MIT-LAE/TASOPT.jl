using Base: SignedMultiplicativeInverse
using NLopt: G_MLSL_LDS, GN_MLSL_LDS, GN_CRS2_LM, GN_DIRECT_L
# Unit tester for TAESOPT.jl
using BenchmarkTools
using Printf
# include("../index.inc")

# ---------------------------
## Testing the fuselage weight module
# ---------------------------
#=
include("../fusew.jl")
(gee, Nland,
Wfix, Wpay, Wpadd, Wseat, Wapu, Weng,
fstring, fframe, ffadd,
deltap,
Wpwindow, Wppinsul, Wppfloor,
Whtail, Wvtail,
rMh, rMv,
Lhmax, Lvmax,
bv, lambdav, nvtail,
Rfuse, dRfuse, wfb, nfweb,
lambdac, xnose, xshell1, xshell2, xconend,
xhtail, xvtail,
xwing, xwbox,
cbox, xfix, xapu, xeng,
hfloor, sigskin, sigbend,
rhoskin, rhobend,
Eskin, Ebend, Gskin) = (9.81, 6.0,
0.13E+05,  0.46E+06,  0.16E+06,  0.46E+05,  0.16E+05,   0.0,
0.34,      0.24,      0.20,
0.56E+05,
0.14E+03,   40.,       60.,
0.26E+05,  0.22E+05,
0.40,      0.70,
0.17E+07,  0.15E+07,
12.,      0.25,       1.0, 
3.1, 0.0,       0.0,       1.0,
0.30,  2.4,       12.,       62.,       72.,
70.,       67., 
40.,       34.,  
5.7,   3.0,  71.,   31.,
0.20,      0.10E+09,  0.21E+09,  0.27E+04,
0.27E+04,  0.69E+11,  0.69E+11,  0.27E+11,)

result = fusew(gee, Nland,
Wfix, Wpay, Wpadd, Wseat, Wapu, Weng,
fstring, fframe, ffadd,
deltap,
Wpwindow, Wppinsul, Wppfloor,
Whtail, Wvtail,
rMh, rMv,
Lhmax, Lvmax,
bv, lambdav, nvtail,
Rfuse, dRfuse, wfb, nfweb,
lambdac, xnose, xshell1, xshell2, xconend,
xhtail, xvtail,
xwing, xwbox,
cbox, xfix, xapu, xeng,
hfloor, sigskin, sigbend,
rhoskin, rhobend,
Eskin, Ebend, Gskin)
=#

# ---------------------------
## Testing blax full
# ---------------------------
#=
include("../blax.jl")
include("../blsys.jl")
include("../blax2.jl")
#inputs from 737
nbldim, nbl, iblte  = [          60          47          31 ];
sbl = [   0.0000000000000000       0.25841299983870264       0.69309443916718450        1.3001178125821706        2.0803642302394660        3.0297111639838339        4.1405214334091553        5.4026510157169643        6.8043898816286141        8.3416218446335328        10.000552428355771        11.763006042166527        13.609672875455766        15.520320459958088        17.474015340908966        19.449352428355770        21.424689515802580        23.378384396753461        25.289031981255782        27.135698814545016        28.898152428355768        30.557093575238806        32.098527634941931        33.515875832618846        34.797462100476722        35.927263281032928        36.886781329295545        37.657175681161526        38.221334951814825        38.565663707653812        38.676246842534837        38.779972475720939        39.089407346005252        39.601363823293127        40.310232805285608        41.208247775075613        42.285569892732411        43.530395791690815        44.929086898905268        46.466318861910182        48.125249445632427        49.887703059443183        51.734369892732417        53.645017477234731        55.598712358185615        57.574049445632426        59.549386533079229        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ]; 
bbl = [   0.0000000000000000        1.4876728081089807        3.4058256034176799        5.4551261640898163        7.5035721481764730        9.4384332795128874        11.139268557067989        12.447915390991129        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        13.028389049617431        12.991192161382012        12.276540876679459        10.836346260450391        8.9215529527316466        6.7831664642886311        4.6594498399912689        2.7639239033344545        1.2747129112121085       0.32571575411203757        8.1428938528009392E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   4.0714469264004696E-002   0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ]; 
rnbl = [  0.25687167487068524       0.52549731623855278       0.77093224537019733       0.87388058682569725       0.92655898110869783       0.95779636867286155       0.97833423687623799       0.99298883438210350       0.99940498221588692        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000       0.99999831036733711       0.99919998466767346       0.99280823486828462       0.97942256294624130       0.96239445494390818       0.94434885779005473       0.92736394348868623       0.91293247282059986       0.90204369867538925       0.92780848366116087       0.97883534072521383       0.99890404250382259        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        1.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ];
univ = [   0.0000000000000000       0.38031630119071819       0.65133000068646940       0.82986457636122890       0.94593900648830542        1.0273647497696450        1.0875710294281722        1.1379596292754699        1.1211770043036997        1.0410745224703368        1.0233748560204126        1.0153656859801528        1.0114146582262913        1.0093288558407103        1.0083771307464999        1.0082617907520570        1.0089589138885453        1.0107065580926284        1.0141479675815785        1.0212689130026895        1.0372367680217678        1.1144811750773000        1.1204432983136237        1.0698988951578923       0.99909801819802468       0.92090964221723726       0.84122659191418603       0.75823296164918463       0.65652375557614617       0.47983269527465694       0.48299181951594639       0.78041993927936115       0.87783297956297346       0.92544045471354175       0.95240359259102925       0.96862638059411565       0.97874472407836843       0.98523226140642761       0.98949362550703812       0.99235592689293306       0.99431919450472406       0.99569255108234722       0.99667107351754636       0.99738029809265483       0.99790253288612152       0.99829271154835397       0.99858812000216846        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ];
Reunit =    7006067.9699355923      ;
Mach =   0.80000000000000004      ;
fex =    1.0300000000000000     

#Fortran reuslts
uebl = [   0.0000000000000000       0.37728242338296181       0.64847633615516287       0.82695029534888154       0.94403149002962905        1.0255943149422753        1.0865499203351234        1.1365507804257704        1.1206431211650818        1.0440948790037765        1.0240821955777670        1.0158405647282294        1.0117347512309973        1.0095591700001416        1.0085471996187523        1.0083948355769166        1.0090823376403273        1.0108720300588245        1.0145032985652438        1.0221896394842940        1.0402657551827854        1.1059092729914484        1.1091568618457064        1.0543655732241883       0.97490990951276690       0.89368511298240294       0.83118999557894302       0.79419493273373520       0.77809105336189510       0.78142056972012308       0.79242533118539638       0.79772286109406265       0.81053258282277518       0.84123660173182713       0.88716224825623247       0.93244222532354892       0.96275025453959628       0.97871685796354857       0.98673875476417017       0.99107603733351624       0.99366250031367975       0.99532641373569586       0.99645251843379634       0.99724082638968936       0.99780393344085772       0.99820042263719722       0.99838556039722948        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ]; 
hkbl = [   0.0000000000000000        1.3878006383330910        1.3464796562458770        1.2841329531938646        1.2957711548906594        1.2666086943831041        1.2667873219861920        1.2551499686354026        1.2703003810691702        1.2907324422017787        1.2593018975066568        1.2487806424396475        1.2423297359023246        1.2377736895702194        1.2341982436579075        1.2311759749694335        1.2284089245123413        1.2255808445615450        1.2221794255394689        1.2168451815800081        1.2059592263759851        1.1693954460989937        1.1814318659577450        1.2288851612693361        1.3020077541398134        1.4034862848531129        1.5185526081155398        1.6114897097201484        1.6546827444891374        1.6259707518242759        1.5786779780686202        1.5551481333557295        1.4996868800960224        1.4070761827361435        1.3136726651554176        1.2479933969997437        1.2114726616058633        1.1921668657173372        1.1806347627072433        1.1724280279402921        1.1658003248537754        1.1600708111266333        1.1549504781978848        1.1503025689488813        1.1460563390645413        1.1421769429235715        1.1386910005249200        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ]; 
phbl = [   0.0000000000000000        3.0682260506125015E-005   4.7889944403344497E-004   2.4975159537457057E-003   7.6025183498762659E-003   1.7075491938605240E-002   3.1774804005064786E-002   5.1993342876357089E-002   7.5806565529789635E-002   9.9331571057468898E-002  0.12134723616883887       0.14314065217342706       0.16513947806483301       0.18732135100076602       0.20956926913881643       0.23173274901782004       0.25365105360216367       0.27516905047121493       0.29615615812688728       0.31655166909860810       0.33650147058369984       0.35720543526812448       0.37712570686668656       0.39265309496967099       0.40327292872315201       0.41058519440318958       0.41595841879182138       0.41988533035222408       0.42246231552153879       0.42384142776268363       0.42423434117475162       0.42468201186142845       0.42613631365539723       0.42790475253569571       0.42946904266257002       0.43066422096273016       0.43159729923635759       0.43240447120609804       0.43315867903042210       0.43388607014134134       0.43459219468942439       0.43527542653948964       0.43593220917558062       0.43655893064098156       0.43715256195251562       0.43771085141483057       0.43823251379636796        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000      ];

### Test blax
uei, dsi, thi, tsi, dci, cfi, cdi, cti, hki, phi = blax2(nbldim, nbl, iblte, sbl, bbl, rnbl, univ, Reunit, Mach, fex);

### Check that the differences between Julia and the orginial FORTRAN code are negligible
match = all(uebl .- uei' .<= sqrt(eps()))
println("Do the blax results match?\n\t $match")


include("../airtable.jl")

nAMa, nAcl, nAτ, nAfun, AMa, Acl, Aτ, A, ∂cdf_∂M, ∂cdp_∂M, ∂cm_∂M = airtable("./air/C.air")
ARe = 20e6
include("../airfun.jl")
include("../surfcd.jl")
include("../fusebl.jl")
include("../cdsum.jl")
include("../trefftz.jl")

### Test total drag calculation

# pari = vec([          24           1           1           1           1           0           0           1           1           2 ]);
# parg = vec([   8.9884656743115795E+307   8.9884656743115795E+307   5556000.0000000000        648362.01179575408        172215.00000000000        13350.000000000000        130391.29613267015        118078.52012781396       0.90000000000000002        19403.519814310472        11269.980000000001        4779.8514160257109        11808.103388796697        1070.0687457149429        2843.8803993915940        364.54518846014219        148414.22395269960        2620.6267705543960        57724.520038175215        92536.770383158291        8.9884656743115795E+307   8.9884656743115795E+307   51868.960943660328        6692.5288922094587        4734.0821916628865        0.0000000000000000        2588867.3172535407        176177.20049393113        179889.18474135827        0.0000000000000000        4669.7561950661729        4664.3309590702556        31329.420951929664        51910.921143353014        34943.047351167166        199022.07245716383        8.9884656743115795E+307   8.9884656743115795E+307  0.20000000000000001       0.34999999999999998       0.10000000000000001       0.10000000000000001       0.10000000000000001        8.9884656743115795E+307  0.20000000000000001       0.10000000000000001        4.0000000000000001E-002  0.10000000000000001       0.14999999999999999        2.0000000000000000E-002   2.9999999999999999E-002  0.29999999999999999       0.40000000000000002        3.5000000000000003E-002   1.0000000000000000E-002   1.0999999999999999E-002   4.3999999999999997E-002  0.34999999999999998       0.25000000000000000       0.20000000000000001        435.00000000000000        22.000000000000000        60.000000000000000        3.0000000000000000        6.0000000000000000        143.92000000000002        2.0000000000000000        1.0000000000000000       0.20000000000000001       0.20000000000000001       0.29999999999999999       0.59999999999999998       0.80000000000000004        16.000000000000000        1.0200000000000000        1.0000000000000000       0.20000000000000001        75205.036158796240        51899.806343219178        1.6499999999999999        2.0000000000000000        0.0000000000000000        37.795200000000001        6.0960000000000001        29.565600000000000        5.1816000000000004        31.089600000000001        35.661600000000000        26.450051770741371        22.397553036942153        35.855445604585157        34.729827466896509        15.849600000000001        19.470338479735002        17.373600000000000        34.899600000000000        33.527999999999999        2.1335999999999999        36.576000000000001        18.897600000000001        4.2671999999999999       0.30480000000000002        4.8768000000000002       -1.6764000000000001        0.0000000000000000        1.0000000000000000        0.0000000000000000        1.9558000000000000       0.38100000000000001       0.12700000000000000       0.29999999999999999        414.54271063740043        1.0000000000000000        0.0000000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   67.637000000000000       0.18500000000000000       0.59999999999999998        3.7999999999999998       0.34200848656294203       0.35093676723249817       -2.0000000000000000E-002 -0.69999999999999996        1.4746689630063814        2.0000000000000000        2.6000000000000001       0.10000000000000001        5.0000000000000003E-002  0.40000000000000002       0.69999999999999996       0.40000000000000002       0.50000000000000000       0.12680000000000000       0.12659999999999999       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000        1.0000000000000000        103448275.86206897        206896551.72413793        206896551.72413793        137931034.48275861        206896551.72413793        1.0000000000000000        68965517241.379318        68965517241.379318        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        817.00000000000000        8.9884656743115795E+307   8.9884656743115795E+307 -0.50000000000000000        683485.87429233151        4135814.6761137857        592397.61226051906        2607866.7469768757        4.9360939188703434E-003   1.2825514741779673E-003   9.9422410532113217E-003   2.2722077041955049E-003   2.2511393356952833E-003   1.1227437653367604E-003   1.8274674395819396E-003   1.1658057574696773E-003   443520352.21829826        3360305548.7945046        393626458.25637054        195365920.57341191        1599509633.6481340        167588748.44332612        66566661.441134661        444788132.91194797        70138876.718455210        192501484.78230000        1354389028.5291059        215052260.51051947        9.8122119871199131E-004   2.3101299478311559E-004   0.0000000000000000        7.0928467266495859E-004   2720415969.0601053        9863437522.9549618        2147117870.7814922        2414531412.2033792        1455447152.9086437        342661986.90299046      -0.29999999999999999       -5.0000000000000003E-002   8.9884656743115795E+307   3.4576574438701595        10.100000000000000        91.334292450529617        30.372295826136508        3.6067999999999998        8.6561043104489048       0.28499999999999998       0.25000000000000000       0.69999999999999996        5.0145380334078409        26.000000000000000        1.4500000000000000        6.0000000000000000        29.678277787192997        13.344274679545457        1.5240000000000000       0.25000000000000000        3.5584732478787875        26.000000000000000       0.10000000000000001        2.0000000000000000        19.733240449554231        6.2822353425439630        0.0000000000000000       0.29999999999999999        4.8324887250338175        25.000000000000000        1.0000000000000000        3.9116000000000000       0.14999999999999999        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        1.8135777410821106        8.9884656743115795E+307   8.9884656743115795E+307   1.7447684296861372        8.9884656743115795E+307   8.9884656743115795E+307   1280.0000000000000       0.50000000000000000        1.4999999999999999E-002  0.10000000000000001        2.5000000000000001E-002  0.34999999999999998        10.668000000000001        2438.4000000000001        35.814000000000000        1.4999999999999999E-002   90.000000000000000        75.000000000000000        8.3616409720407640E-006   8.6646279306829776E-007  0.20904102430101906        5.0968399592252800E-002 ]);
# para = vec([   9753.6000000000004        8.9884656743115795E+307   8.9884656743115795E+307  0.98324093462185735        8.9884656743115795E+307  0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   2.0000000000000001E-004  0.56999999999999995        3.1666666666666662E-002   8.9884656743115795E+307  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.2380000000000000       0.90000000000000002        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307  -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307  -5.8193590257649364E-002  -1.9244973233172872E-002 -0.35990263008567458        0.0000000000000000      -0.18954083880581704        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.303539204265771        18.303539204265771        19.954269775036295        1.0200000000000000        1.0200000000000000        1.0300000000000000        8.5000000000000006E-003   3.5000000000000001E-003   8.9884656743115795E+307   20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ];)
# pare = vec([   8.9884656743115795E+307   280.00000000000000        8.9884656743115795E+307  0.99800000000000000       0.93999999999999995       0.97999999999999998       0.98899999999999999        5.0999999999999996       0.89480000000000004       0.88000000000000000       0.87000000000000000       0.88900000000000001       0.89900000000000002       0.98499999999999999        1.6850000000000001       -7.6999999999999999E-002   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.6850000000000001        8.0000000000000000        3.7500000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307  0.59999999999999998       0.59999999999999998       0.80000000000000004        27417.708624790062        300.48934309870913       0.42510972858024365        1.4586320730442163E-005   224.83527220093063        240.39147447896733        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1587.0000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   300.00000000000000        30000.000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.0000000000000000E-002   2.1999999999999999E-002   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.0000000000000000        1.0000000000000000        200.00000000000000        8.9999999999999997E-002   1.0000000000000000       0.90000000000000002       0.14999999999999999       0.69999999999999996       0.29999999999999999        0.0000000000000000       0.12061791584226822        5.1292591721870069E-002   1.5478853228971187E-002   0.0000000000000000        1280.0000000000000        1280.0000000000000        1280.0000000000000        1280.0000000000000      ]);

pari = vec([          24           1           1           1           1           0           0           1           1           2 ]);
parg = vec([   8.9884656743115795E+307   8.9884656743115795E+307   5556000.0000000000        648362.01179575408        172215.00000000000        13350.000000000000        130391.29613267015        118078.52012781396       0.90000000000000002        19403.519814310472        11269.980000000001        4779.8514160257109        11808.103388796697        1070.0687457149429        2843.8803993915940        364.54518846014219        148414.22395269960        2620.6267705543960        57724.520038175215        92536.770383158291        8.9884656743115795E+307   8.9884656743115795E+307   51868.960943660328        6692.5288922094587        4734.0821916628865        0.0000000000000000        2588867.3172535407        176177.20049393113        179889.18474135827        0.0000000000000000        4669.7561950661729        4664.3309590702556        31329.420951929664        51910.921143353014        34943.047351167166        199022.07245716383        8.9884656743115795E+307   8.9884656743115795E+307  0.20000000000000001       0.34999999999999998       0.10000000000000001       0.10000000000000001       0.10000000000000001        8.9884656743115795E+307  0.20000000000000001       0.10000000000000001        4.0000000000000001E-002  0.10000000000000001       0.14999999999999999        2.0000000000000000E-002   2.9999999999999999E-002  0.29999999999999999       0.40000000000000002        3.5000000000000003E-002   1.0000000000000000E-002   1.0999999999999999E-002   4.3999999999999997E-002  0.34999999999999998       0.25000000000000000       0.20000000000000001        435.00000000000000        22.000000000000000        60.000000000000000        3.0000000000000000        6.0000000000000000        143.92000000000002        2.0000000000000000        1.0000000000000000       0.20000000000000001       0.20000000000000001       0.29999999999999999       0.59999999999999998       0.80000000000000004        16.000000000000000        1.0200000000000000        1.0000000000000000       0.20000000000000001        75205.036158796240        51899.806343219178        1.6499999999999999        2.0000000000000000        0.0000000000000000        37.795200000000001        6.0960000000000001        29.565600000000000        5.1816000000000004        31.089600000000001        35.661600000000000        26.450051770741371        22.397553036942153        35.855445604585157        34.729827466896509        15.849600000000001        19.470338479735002        17.373600000000000        34.899600000000000        33.527999999999999        2.1335999999999999        36.576000000000001        18.897600000000001        4.2671999999999999       0.30480000000000002        4.8768000000000002       -1.6764000000000001        0.0000000000000000        1.0000000000000000        0.0000000000000000        1.9558000000000000       0.38100000000000001       0.12700000000000000       0.29999999999999999        414.54271063740043        1.0000000000000000        0.0000000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   67.637000000000000       0.18500000000000000       0.59999999999999998        3.7999999999999998       0.34200848656294203       0.35093676723249817       -2.0000000000000000E-002 -0.69999999999999996        1.4746689630063814        2.0000000000000000        2.6000000000000001       0.10000000000000001        5.0000000000000003E-002  0.40000000000000002       0.69999999999999996       0.40000000000000002       0.50000000000000000       0.12680000000000000       0.12659999999999999       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000        1.0000000000000000        103448275.86206897        206896551.72413793        206896551.72413793        137931034.48275861        206896551.72413793        1.0000000000000000        68965517241.379318        68965517241.379318        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        817.00000000000000        8.9884656743115795E+307   8.9884656743115795E+307 -0.50000000000000000        683485.87429233151        4135814.6761137857        592397.61226051906        2607866.7469768757        4.9360939188703434E-003   1.2825514741779673E-003   9.9422410532113217E-003   2.2722077041955049E-003   2.2511393356952833E-003   1.1227437653367604E-003   1.8274674395819396E-003   1.1658057574696773E-003   443520352.21829826        3360305548.7945046        393626458.25637054        195365920.57341191        1599509633.6481340        167588748.44332612        66566661.441134661        444788132.91194797        70138876.718455210        192501484.78230000        1354389028.5291059        215052260.51051947        9.8122119871199131E-004   2.3101299478311559E-004   0.0000000000000000        7.0928467266495859E-004   2720415969.0601053        9863437522.9549618        2147117870.7814922        2414531412.2033792        1455447152.9086437        342661986.90299046      -0.29999999999999999       -5.0000000000000003E-002   8.9884656743115795E+307   3.4576574438701595        10.100000000000000        91.334292450529617        30.372295826136508        3.6067999999999998        8.6561043104489048       0.28499999999999998       0.25000000000000000       0.69999999999999996        5.0145380334078409        26.000000000000000        1.4500000000000000        6.0000000000000000        29.678277787192997        13.344274679545457        1.5240000000000000       0.25000000000000000        3.5584732478787875        26.000000000000000       0.10000000000000001        2.0000000000000000        19.733240449554231        6.2822353425439630        0.0000000000000000       0.29999999999999999        4.8324887250338175        25.000000000000000        1.0000000000000000        3.9116000000000000       0.14999999999999999        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        1.8135777410821106        8.9884656743115795E+307   8.9884656743115795E+307   1.7447684296861372        8.9884656743115795E+307   8.9884656743115795E+307   1280.0000000000000       0.50000000000000000        1.4999999999999999E-002  0.10000000000000001        2.5000000000000001E-002  0.34999999999999998        10.668000000000001        2438.4000000000001        35.814000000000000        1.4999999999999999E-002   90.000000000000000        75.000000000000000        8.3616409720407640E-006   8.6646279306829776E-007  0.20904102430101906        5.0968399592252800E-002 ]);
para = vec([   9753.6000000000004        8.9884656743115795E+307   8.9884656743115795E+307  0.98324093462185735        8.9884656743115795E+307  0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   2.0000000000000001E-004  0.56999999999999995        3.1666666666666662E-002   8.9884656743115795E+307  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.2380000000000000       0.90000000000000002        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307  -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307  -5.8193590257649364E-002  -1.9244973233172872E-002 -0.35990263008567458        0.0000000000000000      -0.18954083880581704        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.303539204265771        18.303539204265771        19.954269775036295        1.0200000000000000        1.0200000000000000        1.0300000000000000        8.5000000000000006E-003   3.5000000000000001E-003   8.9884656743115795E+307   20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ]);
pare = vec([   8.9884656743115795E+307   280.00000000000000        8.9884656743115795E+307  0.99800000000000000       0.93999999999999995       0.97999999999999998       0.98899999999999999        5.0999999999999996       0.89480000000000004       0.88000000000000000       0.87000000000000000       0.88900000000000001       0.89900000000000002       0.98499999999999999        1.6850000000000001       -7.6999999999999999E-002   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.6850000000000001        8.0000000000000000        3.7500000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307  0.59999999999999998       0.59999999999999998       0.80000000000000004        27417.708624790062        300.48934309870913       0.42510972858024365        1.4586320730442163E-005   224.83527220093063        240.39147447896733        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1587.0000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   300.00000000000000        30000.000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.0000000000000000E-002   2.1999999999999999E-002   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.0000000000000000        1.0000000000000000        200.00000000000000        8.9999999999999997E-002   1.0000000000000000       0.90000000000000002       0.14999999999999999       0.69999999999999996       0.29999999999999999        0.0000000000000000       0.12061791584226822        5.1292591721870069E-002   1.5478853228971187E-002   0.0000000000000000        1280.0000000000000        1280.0000000000000        1280.0000000000000        1280.0000000000000      ]);

Total_CD =    3.5010536450641325E-002

CD_comps = [  1.1207407385896385E-002   1.0259903311397721E-002   8.7474229316806019E-003   0.0000000000000000        2.2716208269209729E-003   1.6016389099714257E-003   0.0000000000000000        9.2254308477421039E-004  -0.0000000000000000       -0.0000000000000000]

para_old = copy(para)

cdsum!(pari, parg, para, pare, 1)


para_aftercd_fromFORTRAN = vec([   9753.6000000000004        8.9884656743115795E+307   8.9884656743115795E+307  0.98324093462185735        8.9884656743115795E+307  0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   2.0000000000000001E-004  0.56999999999999995        3.5010536450641325E-002   1.1207407385896385E-002  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        1.0259903311397721E-002   8.7474229316806019E-003   2.2716208269209729E-003   1.6016389099714257E-003   9.2254308477421039E-004   0.0000000000000000        0.0000000000000000        2.9533688354080705E-003   1.2380000000000000       0.90000000000000002       0.67215963337633822       0.83871173196072168       0.62131324312786629       -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307  -5.8193590257649364E-002  -1.9244973233172872E-002 -0.35990263008567458        0.0000000000000000      -0.18954083880581704        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.303539204265771        18.303539204265771        19.954269775036295        1.0200000000000000        1.0200000000000000        1.0300000000000000        5.1727648472069346E-003   3.5746580844736677E-003  0.91363621548216079        20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ]);

# find indices of all values that don't match the FORTRAN code
idx = findall(x -> x !=0, para_aftercd_fromFORTRAN - para)
Percent_diff = @. 100*(1 - para[idx]/para_aftercd_fromFORTRAN[idx])
println("Percentage diff for drag values = ", @. round(Percent_diff; digits = 3))
=#

# -------------------------------------
## Balances
# -------------------------------------
#=
println("Testing Balances\n-----------")

include("../balance.jl")
parg = vec([ 8.9884656743115795E+307   8.9884656743115795E+307   5556000.0000000000        648362.01179575408        172215.00000000000        13350.000000000000        130391.29613267015        118078.52012781396       0.90000000000000002        19403.519814310472        11269.980000000001        4779.8514160257109        11808.103388796697        1070.0687457149429        2843.8803993915940        364.54518846014219        148414.22395269960        2620.6267705543960        57724.520038175215        92536.770383158291        8.9884656743115795E+307   8.9884656743115795E+307   51868.960943660328        6692.5288922094587        4734.0821916628865        0.0000000000000000        2588867.3172535407        176177.20049393113        179889.18474135827        0.0000000000000000        4669.7561950661729        4664.3309590702556        31329.420951929664        51910.921143353014        34943.047351167166        199022.07245716383        8.9884656743115795E+307   8.9884656743115795E+307  0.20000000000000001       0.34999999999999998       0.10000000000000001       0.10000000000000001       0.10000000000000001        8.9884656743115795E+307  0.20000000000000001       0.10000000000000001        4.0000000000000001E-002  0.10000000000000001       0.14999999999999999        2.0000000000000000E-002   2.9999999999999999E-002  0.29999999999999999       0.40000000000000002        3.5000000000000003E-002   1.0000000000000000E-002   1.0999999999999999E-002   4.3999999999999997E-002  0.34999999999999998       0.25000000000000000       0.20000000000000001        435.00000000000000        22.000000000000000        60.000000000000000        3.0000000000000000        6.0000000000000000        143.92000000000002        2.0000000000000000        1.0000000000000000       0.20000000000000001       0.20000000000000001       0.29999999999999999       0.59999999999999998       0.80000000000000004        16.000000000000000        1.0200000000000000        1.0000000000000000       0.20000000000000001        75205.036158796240        51899.806343219178        1.6499999999999999        2.0000000000000000        0.0000000000000000        37.795200000000001        6.0960000000000001        29.565600000000000        5.1816000000000004        31.089600000000001        35.661600000000000        26.450051770741371        22.397553036942153        35.855445604585157        34.729827466896509        15.849600000000001        19.470338479735002        17.373600000000000        34.899600000000000        33.527999999999999        2.1335999999999999        36.576000000000001        18.897600000000001        4.2671999999999999       0.30480000000000002        4.8768000000000002       -1.6764000000000001        0.0000000000000000        1.0000000000000000        0.0000000000000000        1.9558000000000000       0.38100000000000001       0.12700000000000000       0.29999999999999999        414.54271063740043        1.0000000000000000        0.0000000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   67.637000000000000       0.18500000000000000       0.59999999999999998        3.7999999999999998       0.34200848656294203       0.35093676723249817       -2.0000000000000000E-002 -0.69999999999999996        1.4746689630063814        2.0000000000000000        2.6000000000000001       0.10000000000000001        5.0000000000000003E-002  0.40000000000000002       0.69999999999999996       0.40000000000000002       0.50000000000000000       0.12680000000000000       0.12659999999999999       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000        1.0000000000000000        103448275.86206897        206896551.72413793        206896551.72413793        137931034.48275861        206896551.72413793        1.0000000000000000        68965517241.379318        68965517241.379318        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        817.00000000000000        8.9884656743115795E+307   8.9884656743115795E+307 -0.50000000000000000        683485.87429233151        4135814.6761137857        592397.61226051906        2607866.7469768757        4.9360939188703434E-003   1.2825514741779673E-003   9.9422410532113217E-003   2.2722077041955049E-003   2.2511393356952833E-003   1.1227437653367604E-003   1.8274674395819396E-003   1.1658057574696773E-003   443520352.21829826        3360305548.7945046        393626458.25637054        195365920.57341191        1599509633.6481340        167588748.44332612        66566661.441134661        444788132.91194797        70138876.718455210        192501484.78230000        1354389028.5291059        215052260.51051947        9.8122119871199131E-004   2.3101299478311559E-004   0.0000000000000000        7.0928467266495859E-004   2720415969.0601053        9863437522.9549618        2147117870.7814922        2414531412.2033792        1455447152.9086437        342661986.90299046      -0.29999999999999999       -5.0000000000000003E-002   8.9884656743115795E+307   3.4576574438701595        10.100000000000000        91.334292450529617        30.372295826136508        3.6067999999999998        8.6561043104489048       0.28499999999999998       0.25000000000000000       0.69999999999999996        5.0145380334078409        26.000000000000000        1.4500000000000000        6.0000000000000000        29.678277787192997        13.344274679545457        1.5240000000000000       0.25000000000000000        3.5584732478787875        26.000000000000000       0.10000000000000001        2.0000000000000000        19.733240449554231        6.2822353425439630        0.0000000000000000       0.29999999999999999        4.8324887250338175        25.000000000000000        1.0000000000000000        3.9116000000000000       0.14999999999999999        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        1.8135777410821106        8.9884656743115795E+307   8.9884656743115795E+307   1.7447684296861372        8.9884656743115795E+307   8.9884656743115795E+307   1280.0000000000000       0.50000000000000000        1.4999999999999999E-002  0.10000000000000001        2.5000000000000001E-002  0.34999999999999998        10.668000000000001        2438.4000000000001        35.814000000000000        1.4999999999999999E-002   90.000000000000000        75.000000000000000        8.3616409720407640E-006   8.6646279306829776E-007  0.20904102430101906        5.0968399592252800E-002])

a = cglpay(parg)
cglpay_fort = [0.0000000000000000        0.0000000000000000       0.45293508213628902       0.44650741075010264        16.916242107986971        19.521486002286334]
println("Cglpay match?\n\t ", all(a .- cglpay_fort' .≈ 0))


#Test HTsize
pari = vec([          24           1           1           1           1           0           0           1           1           2 ])
parg = vec([   8.9884656743115795E+307   8.9884656743115795E+307   5556000.0000000000        749047.16785014025        172215.00000000000        13350.000000000000        209630.16366633351        149603.84846009815       0.90000000000000002        20041.016979277869        11269.980000000001        4779.8514160257109        11808.103388796697        3147.3422330355415        5646.2415456725485        3058.6664838371726        156625.47704664557        2545.9270859780754        55845.790903026435        98891.837327285524        32071.539010163167        10088.948402081525        51312.138566538481        8068.2065084230653        5507.0798717571379        0.0000000000000000        2785319.5803599702        318383.62822945457        189910.51153133909        0.0000000000000000        5882.0796505725575        5498.7228122472488        44605.927378252352        66995.800981846842        55867.252995246643        275276.25586768665        8.9884656743115795E+307   8.9884656743115795E+307  0.20000000000000001       0.34999999999999998       0.10000000000000001       0.10000000000000001       0.10000000000000001        8.9884656743115795E+307  0.20000000000000001       0.10000000000000001        4.0000000000000001E-002  0.10000000000000001       0.14999999999999999        2.0000000000000000E-002   2.9999999999999999E-002  0.29999999999999999       0.40000000000000002        3.5000000000000003E-002   1.0000000000000000E-002   1.0999999999999999E-002   4.3999999999999997E-002  0.34999999999999998       0.25000000000000000       0.20000000000000001        435.00000000000000        22.000000000000000        60.000000000000000        3.0000000000000000        6.0000000000000000        143.92000000000002        2.0000000000000000        1.0000000000000000       0.20000000000000001       0.20000000000000001       0.29999999999999999       0.59999999999999998       0.80000000000000004        16.000000000000000        1.0200000000000000        1.0000000000000000       0.51116644370941600        75205.036158796240        53604.959826854538        1.6499999999999999        2.0000000000000000        0.0000000000000000        37.795200000000001        6.0960000000000001        29.565600000000000        5.1816000000000004        31.089600000000001        35.661600000000000        28.987649009140366        29.180189896399728        35.922062915370866        34.780305369217864        15.849600000000001        19.675324229145570        17.373600000000000        34.899600000000000        33.527999999999999        2.1335999999999999        36.576000000000001        18.897600000000001        4.2671999999999999       0.30480000000000002        4.8768000000000002       -1.6764000000000001        0.0000000000000000        1.0000000000000000        0.0000000000000000        1.9558000000000000       0.38100000000000001       0.12700000000000000       0.29999999999999999        414.54271063740043        1.0000000000000000        0.0000000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   67.637000000000000       0.18500000000000000       0.59999999999999998        3.7999999999999998       0.34200848656294203       0.35093676723249817       -2.0000000000000000E-002 -0.69999999999999996       0.43391799222070221        2.0000000000000000        2.6000000000000001       0.10000000000000001        5.0000000000000003E-002  0.40000000000000002       0.69999999999999996       0.40000000000000002       0.50000000000000000       0.12680000000000000       0.12659999999999999       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000        1.0000000000000000        103448275.86206897        206896551.72413793        206896551.72413793        137931034.48275861        206896551.72413793        1.0000000000000000        68965517241.379318        68965517241.379318        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        817.00000000000000        8.9884656743115795E+307   8.9884656743115795E+307 -0.50000000000000000        631835.02637717943        4168789.5062384852        533396.03084715200        2610325.5149218389        3.9487906659282368E-003   1.0281666226611029E-003   7.7208164943848440E-003   1.7741856040154422E-003   2.2814618194526848E-003   1.1300051985677030E-003   1.8274674395819396E-003   1.1658057574696773E-003   479984853.44014525        3575590096.2937303        424959652.78015149        209910076.17460495        1652763232.9635658        179066586.02302897        82779475.512825429        552552670.16333961        87063408.225471497        226937649.80495596        1596672687.5047660        253522483.94703177        1.0134589441505003E-003   6.7946751811271571E-004   0.0000000000000000        7.0928467266495859E-004   2809794467.6214228        12914309917.951836        2217660822.1930461        8847593589.1140385        1503265458.1758575        1007855380.6513565      -0.29999999999999999       -5.0000000000000003E-002   8.9884656743115795E+307   3.7010887415570961        10.100000000000000        104.90379235519909        32.550396353769806        3.6067999999999998        9.2768629608243938       0.28499999999999998       0.25000000000000000       0.69999999999999996        5.3848505971150775        26.000000000000000        1.4500000000000000        6.0000000000000000        32.885354428722884        14.046783495602732        1.5240000000000000       0.25000000000000000        3.7458089321607284        26.000000000000000       0.10000000000000001        2.0000000000000000        21.425681390048389        6.5460952315175476        0.0000000000000000       0.29999999999999999        5.0354578703981137        25.000000000000000        1.0000000000000000        3.9116000000000000       0.14999999999999999        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        1.4349194389322686       0.68971697539269405       0.37740263678712904        3.4438066534374445       0.22562792174932217       0.68161372700091361        1280.0000000000000       0.50000000000000000        1.4999999999999999E-002  0.10000000000000001        2.5000000000000001E-002  0.34999999999999998        10.668000000000001        2438.4000000000001        35.814000000000000        1.4999999999999999E-002   90.000000000000000        75.000000000000000        8.3616409720407640E-006   8.6646279306829776E-007  0.20904102430101906        5.0968399592252800E-002 ])
paraF = vec([   0.0000000000000000        23802.239035628932        5556000.0000000000       0.76509750813022903        0.0000000000000000       0.24698265925643742        5790522.7452742215        8.9884656743115795E+307  -5.2359877559829883E-002   1.2622355275981707        8.6166089801606421E-002   6.1331866510275966E-002  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        9.2564524635755478E-003   9.4855576690798596E-003   2.3313105346115049E-003   1.6044841132870935E-003   2.1564185107764561E-003   0.0000000000000000        0.0000000000000000        2.7504219370689462E-003   1.1000000000000001       0.50000000000000000        1.6921556133480740        1.8760855140771435       0.86897238873418536      -0.34999999999999998      -0.34999999999999998       -2.0000000000000000E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   2.2500000000000000      -0.12577436927993035       -9.2670444828938145E-002 -0.32730621922474151        0.0000000000000000      -0.19377125493491723        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.373354191913844        18.373354191913844        20.087940295527019        1.0200000000000000        1.0200000000000000        1.0300000000000000        8.5000000000000006E-003   3.5000000000000001E-003  0.81869732538354345        20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ])
paraB = vec([   9753.6000000000004        1043.6233326116253        194057.44279477070       0.97791088406784765        1970.5728293606362       0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   3.0249457051389556E-004  0.56999999999999995        3.5025641294334733E-002   1.1174802789110322E-002  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        9.2564524635755478E-003   8.6436892028697518E-003   2.2656177576942274E-003   1.5592721969178954E-003   2.1258068841669988E-003   0.0000000000000000        0.0000000000000000        2.6991501695632645E-003   1.2380000000000000       0.90000000000000002       0.67034534980117089       0.83644789336637904       0.61963620339494063       -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307  -6.0786166240178102E-002  -1.9662807899898920E-002 -0.36819715010998227        0.0000000000000000      -0.19377125493491723        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.474265333766837        18.474265333766837        20.280230633561800        1.0200000000000000        1.0200000000000000        1.0300000000000000        5.1315538309518096E-003   3.5121353719179444E-003  0.91630192162276147        20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ])
paraC = vec([   9753.6000000000004        1043.6233326116253        194057.44279477070       0.97791088406784765        1970.5728293606362       0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   3.0249457051389556E-004  0.56999999999999995        3.5025641294334733E-002   1.1174802789110322E-002  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        9.2564524635755478E-003   8.6436892028697518E-003   2.2656177576942274E-003   1.5592721969178954E-003   2.1258068841669988E-003   0.0000000000000000        0.0000000000000000        2.6991501695632645E-003   1.2380000000000000       0.90000000000000002       0.67034534980117089       0.83644789336637904       0.61963620339494063       -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307  -6.0786166240178102E-002  -1.9662807899898920E-002 -0.36819715010998227        0.0000000000000000      -0.19377125493491723        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   18.474265333766837        18.474265333766837        20.280230633561800        1.0200000000000000        1.0200000000000000        1.0300000000000000        5.1315538309518096E-003   3.5121353719179444E-003  0.91630192162276147        20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ])

# parg(igSh)      33.081291806941728     
# parg(igxwbox)   16.602428433731806     
# parg(igxwing)   18.904152662877376 
fortran_htsize = 33.081291806941728, 16.602428433731806, 18.904152662877376
htsize( pari,parg,paraF,paraB,paraC)
results = parg[igSh], parg[igxwbox], parg[igxwing]
println("Htsize match? \n\t", all(results .- fortran_htsize .≈ 0))

#Test balance
pari = vec([          24           1           1           1           1           0           0           1           1           2 ])
parg = vec([   8.9884656743115795E+307   8.9884656743115795E+307   5556000.0000000000        648362.01179575408        172215.00000000000        13350.000000000000        130391.29613267015        118078.52012781396       0.90000000000000002        19403.519814310472        11269.980000000001        4779.8514160257109        11808.103388796697        1070.0687457149429        2843.8803993915940        364.54518846014219        148414.22395269960        2620.6267705543960        57724.520038175215        92536.770383158291        8.9884656743115795E+307   8.9884656743115795E+307   51868.960943660328        6692.5288922094587        4734.0821916628865        0.0000000000000000        2588867.3172535407        176177.20049393113        179889.18474135827        0.0000000000000000        4669.7561950661729        4664.3309590702556        31329.420951929664        51910.921143353014        34943.047351167166        199022.07245716383        8.9884656743115795E+307   8.9884656743115795E+307  0.20000000000000001       0.34999999999999998       0.10000000000000001       0.10000000000000001       0.10000000000000001        8.9884656743115795E+307  0.20000000000000001       0.10000000000000001        4.0000000000000001E-002  0.10000000000000001       0.14999999999999999        2.0000000000000000E-002   2.9999999999999999E-002  0.29999999999999999       0.40000000000000002        3.5000000000000003E-002   1.0000000000000000E-002   1.0999999999999999E-002   4.3999999999999997E-002  0.34999999999999998       0.25000000000000000       0.20000000000000001        435.00000000000000        22.000000000000000        60.000000000000000        3.0000000000000000        6.0000000000000000        143.92000000000002        2.0000000000000000        1.0000000000000000       0.20000000000000001       0.20000000000000001       0.29999999999999999       0.59999999999999998       0.80000000000000004        16.000000000000000        1.0200000000000000        1.0000000000000000       0.20000000000000001        75205.036158796240        51899.806343219178        1.6499999999999999        2.0000000000000000        0.0000000000000000        37.795200000000001        6.0960000000000001        29.565600000000000        5.1816000000000004        31.089600000000001        35.661600000000000        26.450051770741371        22.397553036942153        35.855445604585157        34.729827466896509        15.849600000000001        19.470338479735002        17.373600000000000        34.899600000000000        33.527999999999999        2.1335999999999999        36.576000000000001        18.897600000000001        4.2671999999999999       0.30480000000000002        4.8768000000000002       -1.6764000000000001        0.0000000000000000        1.0000000000000000        0.0000000000000000        1.9558000000000000       0.38100000000000001       0.12700000000000000       0.29999999999999999        414.54271063740043        1.0000000000000000        0.0000000000000000        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   67.637000000000000       0.18500000000000000       0.59999999999999998        3.7999999999999998       0.34200848656294203       0.35093676723249817       -2.0000000000000000E-002 -0.69999999999999996        1.4746689630063814        2.0000000000000000        2.6000000000000001       0.10000000000000001        5.0000000000000003E-002  0.40000000000000002       0.69999999999999996       0.40000000000000002       0.50000000000000000       0.12680000000000000       0.12659999999999999       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000       0.50000000000000000       0.14000000000000001       0.75000000000000000        1.0000000000000000        103448275.86206897        206896551.72413793        206896551.72413793        137931034.48275861        206896551.72413793        1.0000000000000000        68965517241.379318        68965517241.379318        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        2700.0000000000000        817.00000000000000        8.9884656743115795E+307   8.9884656743115795E+307 -0.50000000000000000        683485.87429233151        4135814.6761137857        592397.61226051906        2607866.7469768757        4.9360939188703434E-003   1.2825514741779673E-003   9.9422410532113217E-003   2.2722077041955049E-003   2.2511393356952833E-003   1.1227437653367604E-003   1.8274674395819396E-003   1.1658057574696773E-003   443520352.21829826        3360305548.7945046        393626458.25637054        195365920.57341191        1599509633.6481340        167588748.44332612        66566661.441134661        444788132.91194797        70138876.718455210        192501484.78230000        1354389028.5291059        215052260.51051947        9.8122119871199131E-004   2.3101299478311559E-004   0.0000000000000000        7.0928467266495859E-004   2720415969.0601053        9863437522.9549618        2147117870.7814922        2414531412.2033792        1455447152.9086437        342661986.90299046      -0.29999999999999999       -5.0000000000000003E-002   8.9884656743115795E+307   3.4576574438701595        10.100000000000000        91.334292450529617        30.372295826136508        3.6067999999999998        8.6561043104489048       0.28499999999999998       0.25000000000000000       0.69999999999999996        5.0145380334078409        26.000000000000000        1.4500000000000000        6.0000000000000000        29.678277787192997        13.344274679545457        1.5240000000000000       0.25000000000000000        3.5584732478787875        26.000000000000000       0.10000000000000001        2.0000000000000000        19.733240449554231        6.2822353425439630        0.0000000000000000       0.29999999999999999        4.8324887250338175        25.000000000000000        1.0000000000000000        3.9116000000000000       0.14999999999999999        0.0000000000000000        0.0000000000000000        0.0000000000000000        0.0000000000000000        1.8135777410821106        8.9884656743115795E+307   8.9884656743115795E+307   1.7447684296861372        8.9884656743115795E+307   8.9884656743115795E+307   1280.0000000000000       0.50000000000000000        1.4999999999999999E-002  0.10000000000000001        2.5000000000000001E-002  0.34999999999999998        10.668000000000001        2438.4000000000001        35.814000000000000        1.4999999999999999E-002   90.000000000000000        75.000000000000000        8.3616409720407640E-006   8.6646279306829776E-007  0.20904102430101906        5.0968399592252800E-002 ])
para = vec([   9753.6000000000004        8.9884656743115795E+307   8.9884656743115795E+307  0.98324093462185735        8.9884656743115795E+307  0.80000000000000004        7006067.9699355923        8.9884656743115795E+307   2.0000000000000001E-004  0.56999999999999995        3.1666666666666662E-002   8.9884656743115795E+307  0.84846868234950323        7.5885244595022439E-002  0.90549123706947743       0.93708100955735663        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.2380000000000000       0.90000000000000002        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307  -5.9999999999999998E-002  -5.9999999999999998E-002  -5.9999999999999998E-002   1.7999999999999999E-002   1.4000000000000000E-002   4.4999999999999997E-003   8.9884656743115795E+307   0.0000000000000000       -1.9244973233172872E-002 -0.35990263008567458        0.0000000000000000      -0.18954083880581704        8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   8.9884656743115795E+307   1.0200000000000000        1.0200000000000000        1.0300000000000000        8.5000000000000006E-003   3.5000000000000001E-003   8.9884656743115795E+307   20000000.000000000      -0.14999999999999999        6.0000000000000001E-003   3.0000000000000001E-003   10000000.000000000        8.5000000000000006E-003   3.5000000000000001E-003   1000000.0000000000      ])
rfuel =   0.91666666666666707     
rpay =    1.0000000000000000     
xipay =    0.0000000000000000     
iengloc =            1
itrim =            1

# para(iaxCG) =    18.303539204265771     
# para(iaxCP) =    18.303539204265771     
# para(iaxNP) =    19.954269775036295  
fortran_balance = 18.303539204265771,    18.303539204265771   ,    19.954269775036295  

balance(pari, parg, para, rfuel, rpay, xipay, itrim)
results = para[iaxCG], para[iaxCP], para[iaxNP]
println("Balance match?\n\t", all(results .- fortran_balance .≈ 0 ))
# -------------------------------------
=#

## Testing power PowerTrain
    #= 
    include("../index.inc")
    include("../propsys.jl")


    include("../PMSM.jl")  # Motor/generator functions
    include("../PMSM.inc") # Motor/generator properties array
    include("../NPSS_functions.jl") # NPSS functions
    include("../PT.inc")


    gee = 9.81
    μAir = 1.8e-5
    ρAir = 1.225
    # println("Running powertrain...")
    # @timev PowerTrain(0.0, 0.25, 110.0e3*2, parpt, parmot, pargen)
    # println("Second run...")
    ηpt, Ppt, Hpt, mpt, SPpt, mdotf,
    BSFC, deNOx, fanScalars, fanNozArea =  PowerTrain(30000., 0.7, 25.0e3*2,
                                            0.0, 0.0, parpt, parmot, pargen)
    println("η powertrain = ", ηpt)
    println("P powertrain = ", Ppt)
    println("H powertrain = ", Hpt)
    println("SP powertrain = ", SPpt)
    println("Mass powertrain = ", mpt)

    println("Total η = ", prod(ηpt))
    println("Fuel flow = ", mdotf)

    PowerTrainOD(00000., 0.25, 3600., 0.0, 0.0, parpt, parmot, pargen)

=#

## Testing config files
#=
using TOML
 
input = TOML.parsefile("test.toml")

Geom = input["Geometry"]
Geom["Wings"]

TOML.print(input)
=#

## Testing build up of wsize
using StaticArrays
using Profile, UnicodePlots
using PyPlot
# pygui(true)
# plt.style.use(["./prash.mplstyle", "tableau-colorblind10"])
using Dates

include("../index/index.inc")
include("../atmos/atmos.jl")
include("../fuselage/fuseW.jl")

include("../fuselage/fusebl.jl")
include("../boundary_layer/axisol.jl")
include("../boundary_layer/blax.jl")
include("../boundary_layer/blsys.jl")

include("../wing/wingsc.jl")
include("../surf/surfcm.jl")
include("../surf/surfdx.jl")
include("../surf/surfw.jl")
include("../wing/wingpo.jl")
include("../tail/tailpo.jl")

# include("../airtable.jl")
# Create airtables right away cause we aren't going to change them
# nAMa, nAcl, nAτ, nAfun, AMa, Acl, Aτ, A, ∂cdf_∂M, ∂cdp_∂M, ∂cm_∂M = airtable("./air/C.air") 
# ARe = 20e6
# include("../airfun.jl")
include("../aero/airtable2.jl")
include("../aero/airfun2.jl")

include("../balance/balance.jl")
include("../surf/surfcd.jl")
include("../aero/trefftz.jl")
include("../aero/cdsum.jl")

include("../engine/PMSM.jl")  # Motor/generator functions
include("../engine/PMSM.inc") # Motor/generator properties array
include("../engine/NPSS_functions.jl") # NPSS functions
include("../engine/PT.inc")
include("../engine/propsys.jl")

include("../fuel/hydrogen.jl")

include("../tank/tankWmech.jl")
include("../tank/tankWthermal.jl")
include("../tank/tanksize.jl")

include("../sizing/wsize.jl")
include("../mission/mission.jl")

include("input.jl")
# include("../input_fwdTank.jl")
include("../IO/outputs.jl")
include("../IO/savemodel.jl")
include("../fuselage/update_fuse.jl")
include("../cost/cost_est.jl")
include("../utils/printBADA.jl")
include("../mission/odperformance.jl")
include("../contrail/AircraftDeck.jl")
include("../mission/LTO.jl")

const gee = 9.81
TSL, pSL, ρSL, aSL, μSL = atmos(0.0)
RSL =  pSL/(ρSL * TSL)
const gamSL = 1.4
const cpSL  = 1004.0
# temporary
μAir = 1.78e-5 
ρAir = ρSL

time_writing = 0.0
time_run_NPSS = 0.0
f = open("temp.results", "w")
# f = stdout

initwgt = 0
saveOD = true
track_fig = nothing
opt_iter_counter = 0
function run_wsize(iter, initwgt, Ldebug, printiter, saveOD)
    global time_writing = 0.0
    global time_run_NPSS = 0.0
    parpt[ipt_time_NPSS] = 0.0
    parpt[ipt_calls_NPSS] = 0
    global opt_iter_counter += 1

    # println(parg[igWwing])
    Ldebug && println("Max weight iterations = $iter")
    wsize(pari, parg, parm, view(para,:,:,1), view(pare, :,:,1),
                    iter, 0.5, 0.9, 0.5, initwgt, 1, 1, Ldebug, printiter, saveOD)
    # @benchmark PowerTrain(0.0, 0.8, 25.0e3*2,0.0, 0.0, parg, parpt, parmot, pargen)

    ## Write outputs to io stream f
    printoutput = false
    if printoutput
        println(f, "AR  = $(parg[igAR])\n")
        println(f, "CL  = $(para[iaCL, ipcruise1])\n")
        println(f, "Alt  = $(para[iaalt, ipcruise1])\n")
        @printf(f,"--------------------\n")
        println(f, "Fe    = np.array(",pare[ieFe,:], ")")

        println(f, "ηmot     = np.array(", pare[ieemot    , :], ")")
        println(f, "ηinv     = np.array(", pare[ieeinv    , :], ")")
        println(f, "ηcable   = np.array(", pare[ieecable  , :], ")")
        println(f, "ηgen     = np.array(", pare[ieegen    , :], ")")
        println(f, "ηthermal = np.array(", pare[ieethermal, :], ")")

        println(f, "Hmot     = np.array(", pare[ieHrejmot , :], ")")
        println(f, "Hinv     = np.array(", pare[ieHrejinv , :], ")")
        println(f, "Hcable   = np.array(", pare[ieHrejcab , :], ")")
        println(f, "Hgen     = np.array(", pare[ieHrejgen , :], ")")
        println(f, "Htot     = np.array(", pare[ieHrejtot , :], ")")
        println(f, "EINOx1 = np.array(", pare[ieEINOx1, :], ")")
        println(f, "EINOx2 = np.array(", pare[ieEINOx2, :], ")")
        println(f, "FAR = np.array(", pare[ieFAR, :], ")")

        println(f, "h     = np.array(",para[iaalt,:],")")
        println(f, "R     = np.array(",para[iaRange,:],")")
        println(f, "deNOx = np.array(",pare[iedeNOx, :],")")
        println(f, "fracW = np.array(",para[iafracW, :],")")
        println(f, "mdotf = np.array(",pare[iemdotf, :],")")
        println(f, "mdotH2O = np.array(",pare[iemdotf, :].* 9.0,")")
        println(f, "Ptank = np.array(",pare[iePLH2, :],")")
        println(f, "CL = np.array(",para[iaCL, :],")")
        println(f, "CD = np.array(",para[iaCD, :],")")
        println(f, "CLh = np.array(",para[iaCLh, :],")\n")


        # println("Time netNPSS       = $(parpt[ipt_time_NPSS])")
        # println("Time writing       = $time_writing")
        # println("Time runnning NPSS = $time_run_NPSS")
        @printf(f, "\nPFEI = %.5f J/Nm\n", parm[imPFEI])

        weight_buildup(parg, io = f)
        aero(parg, para, io = f)
        geometry(parg, io = f)
    end

    # global track_fig = stickfig(parg, pari,  parm; ax = track_fig)
    if (opt_iter_counter%5 == 0) || (opt_iter_counter == 1)
        global track_fig = plot_details(parg, pari, para, parm; ax = track_fig)
    end
end

time_wsize = @elapsed run_wsize(35, 0, false, true, saveOD)
# @profview run_wsize(25, 0, false, true)
# println("Wsize time = $time_wsize s")
# println("NPSS Time = $(parpt[ipt_time_NPSS]) s")
# println("NPSS Calls = $(parpt[ipt_calls_NPSS])")


# include("../LoadModel.jl")

# Final aircraft:
# include(".././ZIHA/ZIA_BLI_10_8_0.760_15.3.mdl")
# include(".././ZISA/ZIA_SAF_BLI_10_8_0.647_17.4.mdl")

# saveOD = false
# time_wsize = @elapsed run_wsize(30, 1, false, false, saveOD)
# println(para[iagamV, ipclimbn])

# load_aircraft("ZIA_BLI_10_8_0.811_15.8.mdl", "./Models", true)
CostEst(pari, parg, pare, parm, parpt, 1000)


# # ------ Optimzation ---------------
# using NLopt
# xarray = []
# farray = []
# PFEIarray = []
# CDarray = []
# WMTOarray = []

# function obj(x, grad)
#     parg[igAR] = x[1]
#     para[iaalt, ipcruise1, :] .=  x[2] *ft_to_m
#     para[iaCL  , ipclimb1+1:ipdescentn-1, :] .= x[3]
#     parpt[ipt_pifan] = x[4]
#     parg[igsweep   ] = x[5]
    
#     # para[iaMach, ipclimbn:ipdescent1  , :] .= x[6]
#     pare[ieTt4, 1:iptotal, :] .= x[6] # [R]
#     parpt[ipt_Tt41] = pare[ieTt4,ipcruise1, 1]

#     pare[ieTt4, ipstatic:iptakeoff, :] .= x[7] #[R]

#     parg[iglambdas]  = x[8]
#     parg[iglambdat]  = x[9]

#     parg[ighboxo   ] = x[10]
#     parg[ighboxs   ] = x[11]

#     parpt[ipt_piHPC] = x[12]

#     para[iarcls, ipclimb1+1 : ipdescentn-1, :] .= x[13]   #  rcls  
#     para[iarclt, ipclimb1+1 : ipdescentn-1, :] .= x[14]   #  rclt  

#     parg[igARh] = x[15]
#     parg[igsweeph] = x[16]
#     parpt[ipt_Fnsplit] = x[17]
#     # parg[igsweeph] = parg[igsweep]

#     # parg[igRfuse] = x[16]
#     # parg[iglftankin] = x[17]

#     wsize_time = @elapsed run_wsize(50, 1, false, false, saveOD)

#     f = parm[imPFEI]
#     push!(PFEIarray, parm[imPFEI])
#     push!(xarray, x)
#     push!(CDarray, para[iaCD, ipcruise1, 1])
#     push!(WMTOarray, parg[igWMTO])
    
#     # Max span constriant
#     bmax = parg[igbmax]
#     b    = parg[igb]
#     constraint  = b/bmax - 1.0
#     penfac  = 25.0* parg[igWpay]
#     # f = f + penfac*max(0.0, constraint)^2

#     # Min climb gradient
#     gtocmin = parg[iggtocmin]
#     gtoc    = para[iagamV, ipclimbn]
#     constraint = 1.0 - gtoc/gtocmin
#     penfac = 1.0*parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2

#     # Max Tt3 at TOC 
#     Tt3max = 900.0
#     Tt3    = maximum(pare[ieTt3, :, 1])
#     constraint = Tt3/Tt3max - 1
#     penfac = 5.0*parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2
    
#     # Max Tmetal at Rotation
#     Tvanemax = 2400 #Rankine
#     Tvane    = maximum(pare[ieTmet1, :, 1]) #Rankine
#     constraint = Tvane/Tvanemax - 1
#     penfac = 5.0*parg[igWpay]
#     # f = f + penfac*max(0.0, constraint)^2


#     # Ensure fuel volume makes sense
#     Wfmax = parg[iglftankin]  #parg[igWfmax]
#     Wf    = parg[iglftank]    #parg[igWfuel]
#     if (pari[iifwing] ==1)
#         Wfmax = parg[igWfmax]
#         Wf    = parg[igWfuel]
#     end
#     constraint = Wf/Wfmax - 1.0
#     penfac = 10*parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2
#     end

#     # Max Fan diameters
#     dfanmax = 2.0
#     dfan = parg[igdfan]
#     constraint = dfan/dfanmax - 1.0
#     penfac = parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2

#     # Ensure fans will fit within fuselage
#     daftfanmax = min(3.0, 0.9*parg[igRfuse])
#     daftfan = parg[igdaftfan]
#     constraint = daftfan/daftfanmax - 1.0
#     penfac = parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2

#     # Ensure Fans will fit on wing
#     bo = parg[igbo]
#     b  = parg[igb]
#     lmax = b/2*4/5 - (bo/2+2*parg[igdfan])
#     lfans = parg[igneng]/2*parg[igdfan]*1.25
#     constraint = lfans/lmax - 1.0
#     penfac = parg[igWpay]
#     f = f + penfac*max(0.0, constraint)^2
    
#     if (opt_iter_counter%10 == 0) || (opt_iter_counter == 2)
#     printstyled(@sprintf("%6s %4s %4s %5s %5s %5s  %4s  %4s  %5s %5s %5s  %5s  %5s %5s %5s %5s %5s  %5s | %-8s %10s %5s %6s %5s  %6s  %6s %6s %6s %5s %6s %5s  %5s \n",
#     "t", "AR", "h", "CLcr", "FPR", "λ", "T4c", "T4r", "λs", "λt", "hbo", "hbs", "πHPC", "rcls", "rclt", "λh", "ARh", "Fnrat",
#            "f", "PFEI[J/Nm]", "Wf[tons]", "Wwing", "CDwing", "Wf/Wfmax", "γ", "Tt3", "Tvane", "b", "L/D", "dfan", "dfanaft" ); color = :light_green)
#     end
    
#     printstyled(@sprintf("%5.1fs %4.1f %4.1f %5.4f %5.2f %5.2fᵒ %4.0fR %4.0fR %5.4f %5.4f %5.4f  %5.4f  %5.2f %5.3f %5.3f %5.2f %5.2fᵒ %5.2f | %8.6e %10.6f %5.2f %6.3f %5.4f  %6.4f  %6.4f %6.1f %6.1f %5.1fm %6.1f %5.3fm  %5.3fm\n",
#                     wsize_time, x[1], x[2]/1e3, x[3],x[4],x[5],  x[6],  x[7], x[8], x[9],  x[10], x[11], x[12], x[13], x[14], x[15], x[16], x[17], 
#     f, parm[imPFEI], parm[imWfuel]/9.81/1000, parg[igWwing]/9.81/1000, para[iaCDwing, ipcruise1], parg[igWfuel]/parg[igWfmax], para[iagamV, ipclimbn, 1], Tt3, Wf, Wfmax, dfan, daftfan); color = :light_green)

#     # println("X̄ = $x  ⇨  PFEI = $(parm[imPFEI]) f = $f, MTOW = $(parg[igWMTO]), Wtank = $(parg[igWftank]), Wfan = $(parg[igWfan])")
#     push!(farray, f)

#     return f
# end
# # Des. vars:  AR    Alt      Cl    FPR   Λ     Tt4 CR  Tt4 TO  λs   λt   hboxo  hboxs  πHPC  rcls  rclt  ARh     Λh  Fnsplit Rf   lftank   Λh
# lower      = [7.0 , 20000.0, 0.40, 1.20, 10.0, 3200.0, 3200.0, 0.1, 0.1,  0.10,  0.10, 10.0, 0.1,  0.1,  4.0,   5.0, 0.45 ]#, 2.83,  6.0]#,  5.0] 
# upper      = [12.0, 60000.0, 0.65, 1.60, 40.0, 3400.0, 3400.0, 1.0, 1.0,  0.15,  0.15, 20.0, 1.2,  1.0,  8.0,  30.0, 0.7 ]#, 2.87, 20.0]#, 30.0] 

# # got from prior optimization run 
# initial = [7.773081944713115, 40181.603962553054, 0.5527508383478996, 1.230675138085258, 28.62473706060067, 3203.5726595187757, 3598.340134020528, 0.1964082835266504, 0.14368441782959446, 0.11825599806307492, 17.045255858009348, 1.1116365925303677, 0.922992859170234, 5.0445229907657145, 24.70786719622403, 0.5499037770914472]
# initial =  [11.0, 34937.0, 0.500, 1.2126591103869193, 26.686300660179352, 3200.0030186046956, 3400.0, 0.1752945276646451, 0.14, 0.14, 16.71, 1.1030458855952907, 0.9, 6.0, 0.3, 25.0]
# # [9.997431096436161, 38856.75360556306, 0.6045675203477272, 1.2235783865690488, 27.657069015636147, 3218.0635400626825, 3594.8081821795568, 0.13775246610016734, 0.12342780723694166, 0.11848599767102688, 7.071610375877828, 1.199171364736705, 0.9976217470483848, 5.769453459306792, 0.55, 30.0]
# initial = [9.800808554263122, 39209.734944039534, 0.5435602263841047, 1.2187326499096856, 26.415133350952154, 3203.546649444036, 3599.4481633997107, 0.9, 0.10009111870159837, 0.1398701097353828, 0.12337129359538086, 18.881719264268169, 1.0369829799562946, 0.9734146535956018, 7.668225570367148, 29.515164166878304, 0.5490999469170115]
# initial = [8.228454349920403, 39100.86744271755, 0.5852077089083737, 1.2524597900932806, 26.45720878711301, 3201.530593286635, 3599.9974291129274, 0.9655671908068356, 0.10164563435148659, 0.14922775264607838, 0.10853595139952857, 19.364634746000252, 1.0478356751809224, 0.9735662117689496, 5.787416863799637, 29.56757563957012, 0.5308090351667302]

# initial = [parg[igAR], 33000.0, 0.57,
# 1.20, parg[igsweep], 3200, 3300,
# parg[iglambdas], parg[iglambdat], parg[ighboxo   ], parg[ighboxs   ],
# 15.0, para[iarcls, ipcruise1], para[iarclt, ipcruise1], 
# parg[igARh], parg[igsweeph], 0.5]

# initial_dx = [ 0.5  ,  1000.0, 0.005 , 0.05,  0.1,   15.0,   15.0, 0.01, 0.01,  0.001,  0.001,  2.0, 0.01,  0.01, 2.0, 0.1, 0.1]#, 0.2, 2.0]#, 5.0]
# # initial_dx = [ 0.1  ,  10.0, 0.001 , 0.01,  0.01,   1.0,   1.0, 0.001, 0.001,  0.005,  0.005,  0.5, 0.001,  0.001, 0.10, 0.01, 0.05]#, 0.2, 2.0]#, 5.0]

# # if pari[iifuel] == 2
# #     initial = [8.706823321294936, 39324.133600477624, 0.6334358715728483, 1.1932525623004469, 26.344302712899477, 3200.3360554740043, 3459.6712394659494, 0.9, 0.1094619379183989, 0.14110572372270128, 0.11737767098627176, 13.208536486517602, 1.0628009618249974, 0.9933437602824484, 6.542082548728352, 29.246724429560665, 0.5241858300077095]
# #     initial = [8.498746697625975, 36107.236835519856, 0.6412478193423614, 1.2196594875246485, 25.55061885049667, 3200.061100009788, 3300.622159663861, 0.9446505022053928, 0.10000058746957677, 0.12809079514244112, 0.10249631007922386, 15.0, 1.0068733417143467, 0.9546250624086424, 6.4065976827230315, 29.182176695467813, 0.5499999999999989]
# # end
# # include("../ZIA.mdl") # note this will override constraints too!!
# # include("../ZIA_343_918.mdl")

# # x_tol_abs = [0.01, 50.0, 0.0001, 0.001, 0.05, 1.0, 1.0, 0.0001, 0.001, 0.001, 0.01, 0.001, 0.05]
# # f_tol_rel = 1e-6
# f_tol_rel = 1e-5

# opt = NLopt.Opt(:LN_NELDERMEAD, length(initial))
# # opt = NLopt.Opt(:LN_BOBYQA, length(initial))
# # opt = NLopt.Opt(:LN_COBYLA, length(initial))
# # opt = NLopt.Opt(:LN_SBPLX, length(initial))
# # opt = NLopt.Opt(:GN_DIRECT_L, length(initial))

# # opt = NLopt.Opt(:GN_MLSL, length(initial))
# # local_opt = NLopt.Opt(:LN_NELDERMEAD, length(initial))
# # local_opt.ftol_rel = 1e-4
# # local_opt.lower_bounds = lower
# # local_opt.upper_bounds = upper
# # local_opt.min_objective = obj
# # local_opt.initial_step = initial_dx

# # opt.local_optimizer = local_opt

# opt.lower_bounds = lower
# opt.upper_bounds = upper
# opt.min_objective = obj
# opt.initial_step = initial_dx

# # opt.xtol_abs = x_tol_abs
# opt.ftol_rel = f_tol_rel
# # opt.maxeval = 10
# # # nprop = [4, 6, 8, 10, 12, 14, 16]
# # include(".././Models/ZIA_BLI_10_ 8_0.781_14.5.mdl")
# # include(".././Models/ZIA_BLI_10_6_0.823_15.2.mdl")
# # include(".././Models/ZIA_BLI_10_12_0.847_15.2.mdl")    
# nprop = [6, 8, 10, 12]
# nprop = [8]
# # para[iaMach, ipclimbn:ipdescent1  , :] .= 0.8
# Wpay = parg[igWpay]
# frac = [1.0, 0.9, 0.8, 0.6]
# # frac = [0.6]
# Alts = []
# Weight = []
# PaxWeight = []
# S = []
# CL = []
# CD = []
# b = []
# # for n in nprop
# #     # parm[imWpay] = Wpay*n
# #     parpt[ipt_nfan] = n
# #     parg[igneng] =  parpt[ipt_nfan]

# # #     printstyled(@sprintf("\t%10s  %5s  %10s  %6s  %5s  %5s  %10s  %10s  %5s  %5s  %5s  %10s  %5s  %5s %5s  %5s| %10s  %10s  %10s  %10s  %10s  %10s  %10s \n",
# # #     "time2size", "AR", "hcr[ft]", "CLcr", "FPR", "λ[deg]", "Tt4cr[R]", "Tt4ro[R]", "λt", "hbo", "hbs", "πHPC", "rcls", "rclt", "λh", "ARh",
# # #             "PFEI[J/Nm]", "Wf[tons]", "Wf/Wfmax", "γ", "Tt3", "ltank", "ltankin" ); color = :light_green)
# # println(pari[iiVTsize])
#     # opt_time = @elapsed (optf, optx, ret) = NLopt.optimize(opt, initial)
#     # numevals = opt.numevals # the number of function evaluations

#     # # global initial = optx 

#     # println("got $optf at $optx after $numevals iterations which took $(opt_time/60) min (returned $ret)")

#     # savedir = "./Figures/"
#     # if pari[iifuel] == 1
#     #     figname = @sprintf("ZIA_BLI_%d_%d_%.3f_%.1f", seats_per_row, parg[igneng], parm[imPFEI],  para[iaCL, ipcruise1]/para[iaCD, ipcruise1])
#     # elseif pari[iifuel] == 2
#     #     figname = @sprintf("ZIA_SAF_BLI_%d_%d_%.3f_%.1f", seats_per_row, parg[igneng], parm[imPFEI],  para[iaCL, ipcruise1]/para[iaCD, ipcruise1])
#     # end
#     # global track_fig = plot_details(parg, pari, para, parm; ax = track_fig)
#     # plt.savefig(savedir*figname*".png")
#     # savemodel("./Models/"*figname*".mdl", pari, parg, parm, para, pare, parpt, parmot, pargen)
# # push!(Alts, para[iaalt, ipcruise1])
# # push!(Weight, parg[igWMTO])
# # push!(PaxWeight, parg[igWpay])
# # push!(S, parg[igS])
# # push!(CL, para[iaCL, ipcruise1])
# # push!(CD, para[iaCD, ipcruise1])
# # push!(b, parg[igb])

# # #     fig, ax = plt.subplots()
# # #     ax.plot(farray)
# # #     ax.set_xlabel("Iterations")
# # #     ax.set_ylabel("Obj")

# # end

# # fig, ax = plt.subplots(3,1, dpi = 100, sharex = true)
# # ax[1].plot(Weight/9.81/1000, Alts/ft_to_m/1000, ".-", ms = 10)
# # ax[1].set_ylabel("Cruise altitude [kft]")
# # ax[2].plot(Weight/9.81/1000, CL, ".-", ms = 10, label = "CL")
# # ax[2].plot(Weight/9.81/1000, CD*10, ".-", ms = 10, label = "CD*10")
# # ax[2].legend()
# # ax[3].plot(Weight/9.81/1000, b, ".-", ms = 10)

# # ax[end].set_xlabel("MTOW [tonnes]")

# # # # Prepare comparison 
# # models = readdir("./OldModels")
# # PFEI  = zeros(length(models))
# # nProp = zero(PFEI)
# # Ssmax = zero(PFEI)
# # Somax = zero(PFEI)
# # Msmax = zero(PFEI)
# # Momax = zero(PFEI)
# # LD    = zero(PFEI)
# # CD    = zero(PFEI)
# # CDfuse    = zero(PFEI)
# # CDwing    = zero(PFEI)
# # CDi    = zero(PFEI)
# # CDnace    = zero(PFEI)
# # CL    = zero(PFEI)
# # WMTO  = zero(PFEI)
# # Wfuel = zero(PFEI)
# # Wwing = zero(PFEI)
# # Wtesys = zero(PFEI)
# # Wdfans = zero(PFEI)
# # Sref = zero(PFEI)
# # hcr = zero(PFEI)
# # Cost = zero(PFEI)

# # for (i,model) in enumerate(models)
# #     include(".././OldModels/"*model)
# #     Cost[i] = CostEst(parg, pare, parm, parpt, 500)/500

# #     PFEI[i]  = parm[imPFEI]
# #     nProp[i] = parg[igneng]
# #     Ssmax[i] = parg[igSsmax]
# #     Somax[i] = parg[igSomax]
# #     Msmax[i] = parg[igMsmax]
# #     Momax[i] = parg[igMomax]
# #     LD[i]    = para[iaCL, ipcruise1]/para[iaCD, ipcruise1]   
# #     CD[i]    = para[iaCD, ipcruise1]  
# #     CDfuse[i]    = para[iaCDfuse, ipcruise1]  
# #     CDwing[i]    = para[iaCDwing, ipcruise1]  
# #     CDi[i]    = para[iaCDi, ipcruise1]  
# #     CDnace[i]    = para[iaCDnace, ipcruise1]  
# #     CL[i]    = para[iaCL, ipcruise1]   
# #     WMTO[i]  = parg[igWMTO] 
# #     Wfuel[i] = parg[igWfuel]
# #     Wwing[i] = parg[igWwing]
# #     Sref[i] = parg[igS]
# #     hcr[i] = para[iaalt, ipcruise1]
# #     Wtesys[i] = parg[igWtesys]
# #     Wdfans[i] = parg[igneng]*(parg[igWfan] + parg[igWmot])
# # end

# # fig, ax = plt.subplots(4,1, figsize = (6, 8), dpi = 100)
# # ax[1].plot(nProp, PFEI, "o-k")
# # ax[1].set_ylabel("PFEI")
# # ax[2].plot(nProp, WMTO/9.81/1000, "o-k")
# # ax[2].set_ylabel("Max. TO weight [tonnes]")
# # ax[3].plot(nProp, Wfuel/9.81/1000, "o-k")
# # ax[3].set_ylabel("Fuel weight [tonnes]")
# # ax[4].plot(nProp, Cost/1e6,    "o-k")
# # ax[4].set_ylabel("Cost (million \$)")
# # ax[4].set_xlabel("Number of ducted fans")
# # plt.tight_layout()

# # fig, ax = plt.subplots(2,1, figsize = (8,5.5), dpi = 100)
# # ax[1].plot(nProp, Ssmax/1000, "o-k")
# # ax[1].plot(nProp, Somax/1000, "o-b")
# # ax[2].plot(nProp, Msmax/1000, "o-k")
# # ax[2].plot(nProp, Momax/1000, "o-b")

# # fig, ax = plt.subplots(5,1, figsize = (8,5.5), dpi = 100)
# # ax[1].plot(nProp, Sref.*CD, "o-k")
# # ax[2].plot(nProp, Sref.*CDfuse, "o-k")
# # ax[3].plot(nProp, Sref.*CDwing, "o-k")
# # ax[4].plot(nProp, Sref.*CDnace,    "o-k")
# # ax[5].plot(nProp, Sref.*CDi,    "o-k")

# # fig, ax = plt.subplots(5,1, figsize = (8,5.5), dpi = 100)
# # ax[1].plot(nProp, Sref.*CL, "o-k")
# # ax[1].set_ylabel("\$C_L\\times S_{ref}\$")
# # ax[2].plot(nProp, Sref.*CD, "o-k")
# # ax[2].set_ylabel("\$C_D\\times S_{ref}\$")
# # ax[3].plot(nProp, LD, "o-k")
# # ax[3].set_ylabel("\$ \\frac{L}{D} \$")
# # ax[4].plot(nProp, Sref, "o-k")
# # ax[4].set_ylabel("\$ S_{ref}\$")
# # ax[5].plot(nProp, hcr, "o-k")

# # fig, ax = plt.subplots(3,1, figsize = (8,5.5), dpi = 100)
# # ax[1].plot(nProp, Wwing./9.81./1000, "o-k")
# # ax[2].plot(nProp, Wdfans./9.81./1000, "o-k")
# # ax[3].plot(nProp, Wtesys./9.81./1000, "o-k")
