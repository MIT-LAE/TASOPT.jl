include("../src/misc/index.inc")
include("../atmos/atmos.jl")

# airfoil
include("../src/aero/airtable2.jl")
include("../src/aero/airfun2.jl")
include("../src/aero/surfcd.jl")
include("../src/aero/surfcm.jl")
include("../src/aero/wingpo.jl")
include("../src/aero/wingsc.jl")

# bl
include("../src/aero/blsys.jl")
include("../src/aero/fusebl.jl")
include("../src/aero/axisol.jl")
include("../src/aero/blax.jl")

# Trefftz
include("../src/aero/trefftz.jl")

# total cd
include("../src/aero/cdsum.jl")

using ..atmosphere

@testset "airtable2.jl + airfun2.jl + surfcd.jl" begin
    
    # airtable2.jl
    # airtable
    filename = "../air/C.air"
    AMa, Acl, Aτ, ARe,
        A,
        A_M,
        A_τ,
        A_cl,
        A_M_τ,
        A_M_cl,
        A_cl_τ,
        A_M_cl_τ = airtable(filename)

    @test AMa[1] == 0.0
    @test Acl[1] == 0.4
    @test Aτ[1] == 0.09
    @test ARe[1] == 2.0e7
    @test A[1] == 0.00537
    @test A_cl[1] == 9.404466501241549e-5
    @test A_M_τ[1] == 0.0034955756541831962
    @test A_M_cl[1] == 0.00034329926965084645
    @test A_cl_τ[1] == 0.05053716600633287
    @test A_M_cl_τ[1] == -0.10670530182272829

    # airfun2.jl
    # airfun
    cl = 0.5
    τ = 0.12625
    Mach = 0.4

    io, im, dx, t = airfun(cl, τ, Mach, 
                Acl, Aτ, AMa,
                A,
                A_M,
                A_τ,
                A_cl,
                A_M_τ,
                A_M_cl,
                A_cl_τ,
                A_M_cl_τ)

    @test io == 0.005419877363173342
    @test im == 0.0016683437823722376
    @test dx == 0.0
    @test t == -0.10183455655429904

    # surfcd.jl
    # surfcd2

    (S,
	b,bs,bo,
	λt,λs,γt,γs,
	toco,tocs,toct,
	Mach,sweep,co, 
	CL,CLhtail, fLo,fLt,
	Reco,aRexp, kSuns,fexcd,
	fduo,fdus,fdut) = 122.22622227154578, 35.723608571355676, 10.717082571406703, 5.7404, 0.1503, 0.8784, 0.13527, 1.0874591999999998, 0.13, 0.1, 0.1, 0.8, 27.567, 5.251032622415711, 0.57067, -0.06787625812564757, -0.3, -0.05, 3.55659810918534e7, -0.15, 0.5, 1.015, 0.019, 0.011, 0.004
    
    clpo, clps, clpt, CDfwing, CDpwing, CDwing, CDover = surfcd2(
        S,
        b,bs,bo,
        λt,λs,γt,γs,
        toco,tocs,toct,
        Mach,sweep,co, 
        CL,CLhtail, fLo,fLt,
        Reco,aRexp, kSuns,fexcd,
        AMa,Acl,Aτ,ARe,A,
        fduo,fdus,fdut)

    @test clpo == 0.7437828867262967
    @test clps == 0.9354334230981235
    @test clpt == 0.6895561457750707
    @test CDfwing == 0.0050576687628864645
    @test CDpwing == 0.003318992139724786
    @test CDwing == 0.00837666090261125
    @test CDover == 0.0
    
end

@testset "surfcm.jl" begin
    (b,bs,bo, sweep, Xaxis,
		λt,λs,γt,γs,
		AR,fLo,fLt,cmpo,cmps,cmpt) = 35.723608571355676, 10.717082571406703, 5.7404, 27.567, 0.4, 0.1503, 0.8784, 0.09018, 0.96624, 10.4411, -0.3, -0.05, -0.2, -0.2, -0.02

    CM0,CM1 = surfcm(b,bs,bo, sweep, Xaxis,
    λt,λs,γt,γs,
    AR,fLo,fLt,cmpo,cmps,cmpt)

    @test CM0 == -0.05330921996771545
    @test CM1 == -0.3480891589464311

end

@testset "wingpo.jl" begin

    # wingpo
    (b, bs, bo,
    λt, λs, γt, γs,
    AR, N, W, Lhtail, fLo, fLt) = 35.723608571355676, 10.717082571406703, 5.7404, 0.1503, 0.8784, 0.13527, 1.0874591999999998, 10.4411, 3.0, 829005.0550383332, -56120.21501502634, -0.3, -0.05

    po = wingpo(b, bs, bo, λt, λs, γt, γs, AR, N, W, Lhtail, fLo, fLt)

    @test po == 103843.7455446403

end

@testset "wingsc.jl" begin
    (W,CL,qinf,AR,ηsi,bo,λt,λs) = 818857.6734415861, 0.57067, 11739.753869993323, 10.4411, 0.3, 5.7404, 0.1503, 0.8784
    S,b,bs,co = wingsc(W,CL,qinf,AR,ηsi,bo,λt,λs)

    @test S == 122.22622227154578
    @test b == 35.723608571355676
    @test bs == 10.717082571406703
    @test co == 5.251032622415711
end

@testset "fusebl.jl" begin

    # fusebl!
    pari = [1, 1, 1, 2, 2, 0, 0, 2, 1, 2, 0, 0] 
    parg = [0.0, 0.0, 0.0, 0.0, 0.0, 13350.0, 0.0, 0.0, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 0.35, 0.1, 0.1, 0.1, 0.0, 0.18000000000000002, 0.09000000000000001, 0.036000000000000004, 0.09000000000000001, 0.135, 0.018000000000000002, 0.027, 0.3, 0.4, 0.035, 0.01, 0.011, 0.044, 0.35, 0.25, 0.2, 435.0, 22.0, 60.0, 3.0, 6.0, 144.0432, 6.0, 0.0, 0.2, 0.2, 0.0, 0.0, 0.0, 5.333333333333333, 1.02, 1.0, 0.0, 75205.03615879624, 0.0, 1.65, 2.0, 0.0, 44.805600000000005, 6.096, 37.4904, 5.1816, 29.5656, 43.281600000000005, 0.0, 0.0, 0.0, 0.0, 38.862, 0.0, 21.336000000000002, 42.672000000000004, 42.672000000000004, 2.1336, 13.192231680000003, 24.384, 4.2672, 0.3048, 15.24, -1.6764000000000001, 0.0, 1.0, 0.0, 2.8702, 0.0254, 0.127, 0.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 83.0, 0.185, 0.5, 1.0, 0.0, 0.0, -0.02, -1.0, 0.453, 2.0, 2.6, 1.0, 0.05, 0.4, 0.7, 0.4, 0.5, 0.13, 0.1, 0.75, 0.5, 0.14, 0.75, 0.5, 0.14, 0.75, 1.0, 1.0344827586206897e8, 2.0689655172413793e8, 2.0689655172413793e8, 1.379310344827586e8, 2.0689655172413793e8, 1.0, 6.89655172413793e10, 6.89655172413793e10, 2700.0, 2700.0, 2700.0, 2700.0, 2700.0, 62.374682750000005, 0.0, 0.0, -0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.3, -0.05, 0.0, 0.0, 10.4411, 0.0, 0.0, 5.7404, 0.0, 0.3, 0.1503, 0.8784, 0.0, 27.567, 1.45, 6.0, 0.0, 0.0, 2.4384, 0.25, 0.0, 20.0, 0.1, 2.2, 0.0, 0.0, 0.0, 0.3, 0.0, 25.0, 1.0, 3.9116, 0.15, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.015, 0.1, 0.025, 0.35, 10.668000000000001, 2438.4, 35.814, 0.015, 90.0, 75.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 38.862, 40.9956, 18.288, 21.336000000000002, 21.336000000000002, 33.6804, 0.0, 0.0, 40.9956, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 7.62, 120.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    para = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 10058.4 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.8 0.8 0.8 0.8 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.57067 0.57067 0.57067 0.57067 0.57067 0.57067 0.57067 0.57067 0.57067 0.57067 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.1 1.1 1.1 1.1 1.1 1.238 1.238 1.238 1.238 1.238 1.238 1.238 1.238 1.238 1.238 1.1 0.0; 0.6 0.6 0.6 0.6 0.6 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.9 0.5 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; -0.2 -0.2 -0.2 -0.2 -0.2 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.35 0.0; -0.2 -0.2 -0.2 -0.2 -0.2 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.35 0.0; -0.02 -0.02 -0.02 -0.02 -0.02 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.06 -0.02 0.0; 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019 0.019; 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011 0.011; 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004 0.004; 2.25 2.25 2.25 2.25 2.25 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 2.25 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015; 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015 1.015; 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02 1.02; 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085; 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7 2.0e7; -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15 -0.15; 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055 0.0055; 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003 0.003; 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7 1.0e7; 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085 0.0085; 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035 0.0035; 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6 1.0e6; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0]
    ip = 10

    fusebl!(pari, parg, para, ip)

    sum_para = sum(para.^2)

    @test sum_para == 8.517000101171541e15

end

@testset "blax.jl" begin

    (ndim, n,ite) = 60, 47, 31
    xi = [0.0, 0.3842594068565434, 0.9787930092387522, 1.7625584424792344, 2.7345264924657764, 3.889674821956405, 5.21933420355377, 6.712647687064944, 8.370841763793473, 10.193205461871887, 12.159840911929702, 14.249201244431164, 16.43839499034663, 18.70343688487761, 21.01951065503712, 23.361240911929702, 25.702971168822287, 28.0190449389818, 30.28408683351278, 32.47328057942824, 34.562640911929705, 36.52927636198752, 38.35164006006593, 40.014936674221175, 41.53511040507444, 42.90845118526624, 44.10901017471803, 45.09944979140486, 45.84085017229547, 46.30026890160246, 46.44246639320371, 46.565773711810955, 46.932603759648, 47.539519906110236, 48.37987265089165, 49.44445491346528, 50.72160290778423, 52.19732393316234, 53.855449681231086, 55.6778133793095, 57.64444882936731, 59.73380916186878, 61.92300290778424, 64.18804480231522, 66.50411857247472, 68.84584882936731, 71.1875790862599, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    bi = [0.0, 2.287924202870925, 5.227662174230412, 8.343647299442162, 11.412320233051728, 14.229488293516082, 16.55415708289253, 17.99014489590331, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 18.08472712020546, 17.261303034282072, 14.96836539303684, 11.79577427315212, 8.308711186541737, 5.0151118437252835, 2.339571617513135, 0.6017138355703701, 0.15042845889259251, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.07521422944629626, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    rni = [0.15950387896347273, 0.44229752989304527, 0.6889943201743972, 0.8171775988909641, 0.892447835769746, 0.9412789191330396, 0.9755608658910295, 0.9963767522108251, 0.9999887035393724, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.9991498867089303, 0.9865274392251219, 0.9514539329838844, 0.9081206066862675, 0.8664051802364259, 0.8316873075911739, 0.8062834054106921, 0.8488321744190257, 0.9559999228235356, 0.9973522604263125, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    uinv = [0.0, 0.29969836033088126, 0.5533501274527092, 0.7644236178772298, 0.9245348908973786, 1.0585227127863723, 1.1656671386273094, 1.2384274114737783, 1.072037008651141, 1.0389666746714754, 1.0241335678311365, 1.0170269936647967, 1.0130313995130766, 1.0108581902417277, 1.0098074333980414, 1.0096168744708605, 1.0102405878802454, 1.0118399052071472, 1.0148890056519129, 1.020414804395267, 1.0313336702041376, 1.0554937700679046, 1.1568933840696567, 1.2195981825972328, 1.0881217660410556, 0.935815720907598, 0.7878539609057441, 0.6645650734934098, 0.5397397535889091, 0.3965484235330451, 0.3240896092000387, 0.6345504931073231, 0.79158189341195, 0.8730204012252545, 0.9200304867112522, 0.9482460250526882, 0.9656096244646293, 0.9765412016428752, 0.9835830382866529, 0.9882248961892124, 0.9913546154282368, 0.9935109695257504, 0.9950272967866506, 0.9961139975712349, 0.9969065530822443, 0.9974939153523666, 0.9979355830997496, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    (Reyn, Mach, fexcr) = 6.773140380051848e6, 0.8, 1.02

    uei, dsi, thi, tsi, dci, cfi, cdi, cti, hki, phi = blax(ndim, n,ite, xi, bi, rni, uinv, Reyn, Mach, fexcr)
    sum_phi = sum(phi.^2)
    sum_hki = sum(hki.^2)

    @test sum_phi == 15.548545836534393
    @test sum_hki == 84.30648200135062

end

@testset "blsys.jl" begin

    # blsys
    (simi, lami, wake, direct) = (false, false, true, true)
    Mach = 0.83999999999999997
    uinv = 0.99923266171096192
    hksep = 2.8999999999999999

    x = 113.19176121887341
    b = 4.2512954905511248E-002
    rn = 1.0000000000000000
    th = 0.36151524580335676
    ds = 0.47411597247856280
    ue = 0.99923266171096192

    h = 1.3114688190396659
    h_th = -3.6276998944410455
    h_ds = 2.7661350706740091

    hk = 1.0255741688623847
    hk_th = -3.3602469158702317
    hk_ds = 2.5622011496474624
    hk_ue = -0.60482391056544504

    hc = 0.18475056251156852
    hc_th = -0.51104501029000049
    hc_ds = 0.38967377864478508
    hc_ue = 0.42195763911809053

    hs = 1.9793306587190489
    hs_th = 2.6598043330637906
    hs_ds = -2.0281130759023553
    hs_ue = 0.47920941853514037

    cf = 0.0000000000000000
    cf_th = 0.0000000000000000
    cf_ds = 0.0000000000000000
    cf_ue = 9.7873179306789851E-005

    di = 1.1201590943705716E-006
    di_th = -4.3053013257921013E-004
    di_ds = 3.2828087586136393E-004
    di_ue = 1.6832700785353640E-005

    xm = 109.41631855980170
    bm = 4.2512954905511248E-002
    rnm = 1.0000000000000000
    thm = 0.36159007642163560
    dsm = 0.47420811585137385
    uem = 0.99907993608762147

    (hm, hm_thm, hm_dsm) = (1.3114522484669959, -3.6269034544711247, 2.7655627253761956)

    (hkm, hkm_thm, hkm_dsm, hkm_uem) = (1.0256511654878535, -3.3595955637851405, 2.5617368590524694, -0.60473072971602160)

    (hcm, hcm_thm, hcm_dsm, hcm_uem) = (0.18468380516008143,-0.51075464753136102,0.38945729677035568, 0.42186741128515043)

    (hsm, hsm_thm, hsm_dsm, hsm_uem) = (1.9792696450491154,2.6589664547453919, -2.0274998135942890,0.47907891555231130)

    (cfm, cfm_thm, cfm_dsm, cfm_uem) = (0.00, 0.00, 0.00, 0.00)

    (dim, dim_thm, dim_dsm, dim_uem) = (1.1300768260643012E-006,  -4.3292178714927860E-004,
                                        3.3010869260038754E-004,   1.6387793785720393E-005)

    (aa, bb, rr) = blsys(simi,lami,wake,direct, Mach, uinv,hksep, x,b,rn,th,ds,ue,
                        h , h_th, h_ds,
                        hk, hk_th, hk_ds, hk_ue,
                        hc, hc_th, hc_ds, hc_ue,
                        hs, hs_th, hs_ds, hs_ue,
                        cf, cf_th, cf_ds, cf_ue,
                        di, di_th, di_ds, di_ue,
                        xm,bm,rnm,thm,dsm,uem,
                        hm , hm_thm, hm_dsm,
                        hkm, hkm_thm, hkm_dsm, hkm_uem,
                        hcm, hcm_thm, hcm_dsm, hcm_uem,
                        hsm, hsm_thm, hsm_dsm, hsm_uem,
                        cfm, cfm_thm, cfm_dsm, cfm_uem,
                        dim, dim_thm, dim_dsm, dim_uem)

    solved_bl_sys = aa\rr

    @test solved_bl_sys[1] ≈ -7.6910181160795242E-009 rtol = 1e-8
    @test solved_bl_sys[2] ≈ -8.8941884720010155E-009 rtol = 1e-8
    @test solved_bl_sys[3] ≈ 0.0000000000000000 atol = 1e-8

end

@testset "axisol.jl" begin
    (xnose,xend,xblend1,xblend2, Amax, 
	anose, btail, iclose,
	Mach, nc, nldim) = 0.0, 44.805600000000005, 6.096, 37.4904, 26.026397362383797, 1.65, 2.0, 0, 0.8, 30, 60
    xl = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    zl = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    sl = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    dyl = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    ql = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

    nl, ilte = axisol!(xnose,xend,xblend1,xblend2, Amax, 
	anose, btail, iclose,
	Mach, nc, nldim,
      xl, zl, sl, dyl, ql)

    sum_ql = sum(sl.^2)

    @test nl == 47
    @test ilte == 31
    @test sum_ql == 76987.70188944043

end

@testset "trefftz.jl" begin

    # trefftz1

    nsurf, npout, npinn, npimg =[2      ,
                    [  20          10],
                    [           6           0   ],
                    [3           2 ]   ]
    Sref, bref=   [91.334292450529617        30.372295826136508      ]
    b,bs,bo,bop, zcent=[   [30.372295826136508        13.344274679545457] ,
    [  8.6561043104489048        1.5240000000000000   ],
    [  3.6067999999999998        1.5240000000000000   ],
    [  0.72136000000000000        1.5240000000000000  ],
    [  -1.6764000000000001        0.0000000000000000  ]  ]

    po,gammat,gammas,fLo,ktip=[   [1.0000000000000000        1.0000000000000000   ],
    [ 0.22500000000000001       0.25000000000000000 ],
    [ 0.86659999999999993        1.0000000000000000 ],
        -0.29999999999999999       ,        16 ]
    Lspec = true
    CLsurfsp=[0.58890949708770191       -1.8909497087701926E-002 ]

    idim,ifrst,ilast=[         360           0           0           0           0 ]
    CLsurf,CL,CD,spanef=[  0.58890949708770202       -1.8909497087701926E-002  0.57000000000000006        1.1207407385896385E-002  0.91363621548216079      ]

    CLsurf, CL, CD , spanef = trefftz1(nsurf, npout, npinn, npimg,
        Sref, bref, b, bs, bo, bop, zcent,
        po, gammat, gammas, fLo, ktip,
        Lspec, CLsurfsp)

    @test CLsurf[1] == 0.5889094970877019
    @test CLsurf[2] == -0.018909497087701926
    @test CL == 0.57
    @test CD == 0.011207407385896385
    @test spanef == 0.9136362154821606

end

@testset "cdsum.jl" begin

    # cdsum!
    pari = [1, 1, 1, 2, 2, 0, 0, 2, 1, 2, 0, 0]
    parg = [0.0, 0.0, 5.556e6, 829005.0550383332, 210400.90060000002, 13350.0, 167374.55889478658, 0.0, 0.9, 40187.09865538141, 10607.04, 6927.910283793743, 22672.596888283624, 3095.528989869617, 3785.2141211983876, 1105.6126845279498, 203775.43841405472, 3877.8095115396713, 86191.12174302412, 123574.54297859629, 0.0, 0.0, 0.0, 7805.337276100092, 6787.723600730081, 0.0, 3.3590451555365003e6, 0.0, 233878.9111832231, 0.0, 3883.8857687655345, 7547.007038880155, 16446.156130142692, 32906.01567823227, 19579.97946378206, 122537.30425063636, 0.0, 0.0, 0.2, 0.35, 0.1, 0.1, 0.1, 0.0, 0.18000000000000002, 0.09000000000000001, 0.036000000000000004, 0.09000000000000001, 0.135, 0.018000000000000002, 0.027, 0.3, 0.4, 0.035, 0.01, 0.011, 0.044, 0.35, 0.25, 0.2, 435.0, 22.0, 60.0, 3.0, 6.0, 144.0432, 6.0, 0.0, 0.2, 0.2, 0.0, 0.0, 0.0, 5.333333333333333, 1.02, 1.0, 0.2, 75205.03615879624, 52946.47095778573, 1.65, 2.0, 0.0, 44.805600000000005, 6.096, 37.4904, 5.1816, 29.5656, 43.281600000000005, 30.741250663736736, 13.29750411862306, 43.36770803641874, 44.028248173728734, 38.862, 23.559394039233574, 21.336000000000002, 42.672000000000004, 42.672000000000004, 2.1336, 13.192231680000003, 24.384, 4.2672, 0.3048, 15.24, -1.6764000000000001, 0.0, 1.0, 0.0, 2.8702, 0.0254, 0.127, 0.3, 775.0324352936026, 1.0, 0.0, 0.0, 0.0, 24.685846502327323, 161.90469706362177, 0.185, 0.5, 1.0, 0.48057853467538025, 0.09407916727675364, -0.02, -1.0, 0.167550353309227, 2.0, 2.6, 1.0, 0.05, 0.4, 0.7, 0.4, 0.5, 0.13, 0.1, 0.75, 0.5, 0.14, 0.75, 0.5, 0.14, 0.75, 1.0, 1.0344827586206897e8, 2.0689655172413793e8, 2.0689655172413793e8, 1.379310344827586e8, 2.0689655172413793e8, 1.0, 6.89655172413793e10, 6.89655172413793e10, 2700.0, 2700.0, 2700.0, 2700.0, 2700.0, 62.374682750000005, 0.0, 0.0, -0.5, 936690.5267814544, 5.700105292875066e6, 761672.5818643003, 3.5555586942238403e6, 0.006231565885080871, 0.0016072437249458626, 0.008024305048438624, 0.0022019762546879157, 0.0016695605802994756, 0.0009721946636650935, 0.0022317902006804696, 0.0012852080345164836, 6.565536910523491e8, 4.83787573343785e9, 5.769689215455322e8, 2.763185646268206e8, 3.620518174257911e9, 2.780571011097494e8, 9.465087579637146e7, 6.49407790970752e8, 1.0360820570188637e8, 2.5805870179487053e8, 1.781058339333864e9, 2.818323019709408e8, 0.001469013955782687, 0.00016966161136311304, 0.0, 0.0012588335807398987, 1.0274506065333044e10, 2.258780773038762e10, 1.015963348792316e10, 0.0, 5.837931591133135e9, 6.742433432169461e8, -0.3, -0.05, 0.0, 4.028363031356956, 10.4411, 122.22622227154578, 35.723608571355676, 5.7404, 10.717082571406703, 0.3, 0.1503, 0.8784, 5.251032622415711, 27.567, 1.45, 6.0, 37.35434166299239, 14.970839989057204, 2.4384, 0.25, 3.992223997081922, 20.0, 0.1, 2.2, 22.84545462061691, 7.089428761568678, 0.0, 0.3, 4.957642490607467, 25.0, 1.0, 3.9116, 0.15, 0.0, 0.0, 0.0, 0.5, 1.1573477154507463, 0.0, 0.0, 1.9390261184266264, 0.0, 0.0, 0.0, 0.5, 0.015, 0.1, 0.025, 0.35, 10.668000000000001, 2438.4, 35.814, 0.015, 90.0, 75.0, 0.0, 0.0, 0.0, 0.0, 33664.144096, 13465.657638400002, 0.0, 0.0, 0.0, 0.0, 38.862, 40.9956, 18.288, 21.82488990465161, 21.32488990465161, 33.6804, 0.0, 0.0, 40.9956, 6732.828819200001, 67328.288192, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1007.5873691128613, 2.0, 8.97742122407371, 1.2962238577253733, 7.62, 120.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    para = [10058.4, 0.0, 0.0, 0.9831751569871261, 0.0, 0.8, 6.773140380051848e6, 0.0, 0.0002, 0.57067, 0.03170388888888889, 0.0, 1.4623702690268179, 0.14339629966274048, 1.6084529878675842, 1.6433078323176022, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.238, 0.9, 0.0, 0.0, 0.0, -0.06, -0.06, -0.06, 0.019, 0.011, 0.004, 0.0, -0.222096234153297, -0.019286870771467637, -0.37480245321681793, 0.0, -0.08385073591562085, 0.0, 0.0, 0.0, 20.24289668022716, 20.24289668022716, 24.685846502327323, 1.015, 1.015, 1.02, 0.0085, 0.0035, 0.0, 2.0e7, -0.15, 0.0055, 0.003, 1.0e7, 0.0085, 0.0035, 1.0e6, 0.0, 0.0, 0.0]
    pare = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.6, 0.0, 0.8, 26204.80774552081, 299.1999012290012, 0.40981336891208897, 1.4482631408254694e-5, 222.90981298666367, 239.359920983201, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 3000.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]
    icdfun = 1

    cdsum!(pari,parg,para,pare, icdfun)

    @test para == [10058.4, 0.0, 0.0, 0.9831751569871261, 0.0, 0.8, 6.773140380051848e6, 0.0, 0.0002, 0.57067, 0.037806189054748356, 0.011912179695751686, 1.4623702690268179, 0.14339629966274048, 1.6084529878675842, 1.6433078323176022, 0.013444805883525729, 0.00837666090261125, 0.002458519387711812, 0.001296669472819468, 0.0009039557401001627, 0.0, 0.0, 0.0028938645310570645, 1.238, 0.9, 0.7437828867262967, 0.9354334230981235, 0.6895561457750707, -0.06, -0.06, -0.06, 0.019, 0.011, 0.004, 0.0, -0.222096234153297, -0.019286870771467637, -0.37480245321681793, 0.0, -0.08385073591562085, 0.0, 0.0, 0.0, 20.24289668022716, 20.24289668022716, 24.685846502327323, 1.015, 1.015, 1.02, 0.0050576687628864645, 0.003318992139724786, 0.8334560830483152, 2.0e7, -0.15, 0.0055, 0.003, 1.0e7, 0.0085, 0.0035, 1.0e6, -0.000586602027771757, -0.0, 0.0]
    
end